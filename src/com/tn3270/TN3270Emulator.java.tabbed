package com.tn3270;

import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.net.*;
import java.util.*;
import java.util.List;
import javax.swing.*;
import javax.swing.border.*;
import java.awt.image.BufferedImage;

public class TN3270Emulator extends JFrame {

    // UI Components
    public JTabbedPane tabbedPane;
    private EnhancedRibbonToolbar ribbon;
    private ModernKeyboardPanel keyboardPanel;
    private JMenuBar menuBar;

    // Profile Persistence
    private static final String PROFILES_FILE = System.getProperty("user.home") + File.separator + ".tn3270profiles";
    private static final Map<String, ConnectionProfile> savedProfiles = new HashMap<>();

    static {
        loadProfiles();
    }

    // Inner class for Profiles
    static class ConnectionProfile {
        String name;
        String hostname;
        int port;
        String model;
        String luName;
        boolean useTLS;

        ConnectionProfile(String name, String hostname, int port, String model, String luName, boolean useTLS) {
            this.name = name;
            this.hostname = hostname;
            this.port = port;
            this.model = model;
            this.luName = luName;
            this.useTLS = useTLS;
        }

        @Override
        public String toString() {
            return name + " (" + hostname + ":" + port + ")";
        }
    }

    private static void loadProfiles() {
        File file = new File(PROFILES_FILE);

        if (!file.exists()) {
            // Load defaults if no file exists
            savedProfiles.put("Local z/VM", new ConnectionProfile("Local z/VM", "localhost", 23, "3279-3", "", false));
            savedProfiles.put("Local z/OS", new ConnectionProfile("Local z/OS", "localhost", 23, "3279-3", "", false));
            return;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");

                // Handle different versions of the file format
                if (parts.length >= 5) {
                    String name = parts[0];
                    String host = parts[1];
                    int port = 23;
                    try {
                        port = Integer.parseInt(parts[2]);
                    } catch (Exception e) {
                    }
                    String model = parts[3];

                    // Backward Compatibility Logic
                    String luName = "";
                    boolean useTLS = false;

                    if (parts.length == 5) {
                        // OLD Format: Name,Host,Port,Model,TLS
                        useTLS = Boolean.parseBoolean(parts[4]);
                    } else if (parts.length >= 6) {
                        // NEW Format: Name,Host,Port,Model,LU,TLS
                        luName = parts[4];
                        useTLS = Boolean.parseBoolean(parts[5]);
                    }

                    savedProfiles.put(name, new ConnectionProfile(name, host, port, model, luName, useTLS));
                }
            }
        } catch (IOException e) {
            System.err.println("Error loading profiles: " + e.getMessage());
        }
    }

    private static void saveProfiles() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(PROFILES_FILE))) {
            for (ConnectionProfile profile : savedProfiles.values()) {
                writer.write(profile.name + "," + profile.hostname + "," + profile.port + "," + profile.model + ","
                        + (profile.luName == null ? "" : profile.luName) + "," + profile.useTLS);
                writer.newLine();
            }
        } catch (IOException e) {
            System.err.println("Could not save profiles: " + e.getMessage());
        }
    }

    // =======================================================================
    // CONSTRUCTOR & SESSION MANAGEMENT
    // =======================================================================

    public TN3270Emulator(String initialModel) {
        super("TN3270 Emulator");
        setLayout(new BorderLayout());
        setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);

        // 1. Setup Tabs
        tabbedPane = new JTabbedPane();
        tabbedPane.addChangeListener(e -> {
            TN3270Session s = getCurrentSession();
            if (s != null) s.requestFocusInWindow();
        });
        add(tabbedPane, BorderLayout.CENTER);

        // 2. Handle Initial Session
        if (initialModel == null || initialModel.trim().isEmpty()) {
            initialModel = "3279-3";
        }
        // Open the first tab (disconnected)
        openNewSession(null, 0, initialModel, "", false);

        // 3. Setup Menus
        createMenuBar();
        
        // 4. Setup Toolbar (North)
        ribbon = new EnhancedRibbonToolbar(this);
        add(ribbon, BorderLayout.NORTH);

        // 5. Setup Shared Keyboard (South)
        keyboardPanel = new ModernKeyboardPanel(this);
        add(keyboardPanel, BorderLayout.SOUTH);

        // 6. Global Focus Handler
        addWindowFocusListener(new WindowAdapter() {
            public void windowGainedFocus(WindowEvent e) {
                TN3270Session s = getCurrentSession();
                if (s != null) s.requestFocusInWindow();
            }
        });

        // 7. Window Close Handler
        addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent e) {
                // Loop through tabs and disconnect
                for(int i=0; i<tabbedPane.getTabCount(); i++) {
                    Component c = tabbedPane.getComponentAt(i);
                    if(c instanceof TN3270Session) ((TN3270Session)c).disconnect();
                }
                System.exit(0);
            }
        });

        // 8. Finalize Window
        pack();
        // Ensure decent size if pack is small
        if (getWidth() < 1000) setSize(1100, 850);
        setLocationRelativeTo(null); 
        setVisible(true);
    }

    public TN3270Session getCurrentSession() {
        if (tabbedPane.getTabCount() == 0) return null;
        Component c = tabbedPane.getSelectedComponent();
        if (c instanceof TN3270Session) return (TN3270Session) c;
        return null;
    }

    public void openNewSession(String h, int p, String m, String l, boolean t) {
        TN3270Session s = new TN3270Session(m, this);
        s.setUseTLS(t);
        s.setRequestedLuName(l);
        tabbedPane.addTab(h == null ? "New Session" : h, s);
        tabbedPane.setSelectedComponent(s);
        if (h != null)
            s.connect(h, p);
    }

    public void closeSession(TN3270Session s) {
        s.disconnect();
        tabbedPane.remove(s);
        if (tabbedPane.getTabCount() == 0)
            System.exit(0);
    }

    // =======================================================================
    // MAIN ENTRY POINT
    // =======================================================================

    public static void main(String[] args) {
        // 1. MacOS Specific Configuration
        String osName = System.getProperty("os.name").toLowerCase();
        if (osName.contains("mac")) {
            System.setProperty("apple.laf.useScreenMenuBar", "true");
            System.setProperty("apple.awt.application.name", "TN3270");
        }

        // 2. Set Look and Feel
        try {
            UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
        } catch (Exception e) {
            System.err.println("Could not set look and feel: " + e.getMessage());
        }

        // 3. If no arguments, show the GUI Dialog immediately
        if (args.length == 0) {
            showConnectionDialog();
            return;
        }

        // 4. Parse Arguments
        String hostname = null;
        int port = 23;
        String rawModel = "3278-2";
        String luName = null;
        boolean useTLS = false;

        try {
            for (int i = 0; i < args.length; i++) {
                String arg = args[i];
                switch (arg) {
                    case "-h": case "--host":
                        if (i + 1 < args.length) hostname = args[++i];
                        else printUsageAndExit("Missing value for host");
                        break;
                    case "-p": case "--port":
                        if (i + 1 < args.length) {
                            try { port = Integer.parseInt(args[++i]); } 
                            catch (NumberFormatException e) { printUsageAndExit("Invalid port: " + args[i]); }
                        } else printUsageAndExit("Missing value for port");
                        break;
                    case "-m": case "--model":
                        if (i + 1 < args.length) rawModel = args[++i];
                        else printUsageAndExit("Missing value for model");
                        break;
                    case "-l": case "--luname":
                        if (i + 1 < args.length) luName = args[++i];
                        else printUsageAndExit("Missing value for LU Name");
                        break;
                    case "--tls":
                        useTLS = true;
                        break;
                    case "--help": case "-?":
                        printUsage();
                        System.exit(0);
                        break;
                    default:
                        if (!arg.startsWith("-") && hostname == null) hostname = arg;
                        else printUsageAndExit("Unknown option: " + arg);
                        break;
                }
            }
        } catch (Exception e) {
            printUsageAndExit("Error parsing arguments: " + e.getMessage());
        }

        if (hostname == null) {
            printUsageAndExit("Hostname is required.");
        }

        String finalModel = normalizeModel(rawModel);

        System.out.println("Connecting to " + hostname + ":" + port + " (" + (useTLS ? "TLS" : "Plain") + ")");
        
        // 5. Launch Emulator with specific session
        // We initialize the frame with the model
        TN3270Emulator emulator = new TN3270Emulator(finalModel);
        
        // The constructor creates a blank "New Session" tab by default.
        // Since we are connecting immediately via CLI, we should close that blank tab
        // and open our specific connection tab.
        TN3270Session blankSession = emulator.getCurrentSession();
        if (blankSession != null) {
            emulator.closeSession(blankSession);
        }
        
        // Open the actual requested connection
        emulator.openNewSession(hostname, port, finalModel, luName, useTLS);
    }

    private static String normalizeModel(String input) {
        if (input == null) return "3278-2";
        switch (input.trim()) {
            case "2": return "3278-2";
            case "3": return "3278-3";
            case "4": return "3278-4";
            case "5": return "3278-5";
            default: return input.trim();
        }
    }

    private static void printUsage() {
        System.out.println("Usage: java TN3270Emulator [options] <hostname>");
        System.out.println("Options:");
        System.out.println("  -h, --host <name>    Target hostname");
        System.out.println("  -p, --port <num>     Target port (default: 23)");
        System.out.println("  -m, --model <id>     Terminal Model (2, 3, 4, 5 or '3279-3')");
        System.out.println("  -l, --luname <name>  Specific LU Name (TN3270E)");
        System.out.println("  --tls                Enable TLS/SSL");
        System.out.println("  --help               Show this message");
    }

    private static void printUsageAndExit(String error) {
        System.err.println("Error: " + error);
        System.err.println();
        printUsage();
        System.exit(1);
    }
    
 // =======================================================================
    // DIALOGS & UI HELPERS
    // =======================================================================

    public static void showConnectionDialog() {
        // Find the active window to parent the dialog
        Frame[] frames = Frame.getFrames();
        TN3270Emulator activeWindow = null;
        for (Frame f : frames) {
            if (f instanceof TN3270Emulator && f.isVisible()) {
                activeWindow = (TN3270Emulator) f;
                break;
            }
        }

        JDialog dialog = new JDialog(activeWindow, "Connect to Host", true);
        dialog.setLayout(new BorderLayout(15, 15));

        JPanel mainContainer = new JPanel(new BorderLayout(10, 10));
        mainContainer.setBorder(new EmptyBorder(15, 15, 15, 15));

        // --- Top Panel: Profile Selection ---
        JPanel topPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.weightx = 0;
        topPanel.add(new JLabel("Saved Profiles:"), gbc);

        gbc.gridx = 1;
        gbc.weightx = 1.0;
        JComboBox<String> profileChoice = new JComboBox<>();
        profileChoice.addItem("(New Connection)");
        for (String profileName : savedProfiles.keySet()) {
            profileChoice.addItem(profileName);
        }
        topPanel.add(profileChoice, gbc);

        mainContainer.add(topPanel, BorderLayout.NORTH);

        // --- Center Panel: Inputs ---
        JPanel centerPanel = new JPanel(new GridBagLayout());

        // 1. Hostname
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.weightx = 0;
        centerPanel.add(new JLabel("Hostname:", SwingConstants.RIGHT), gbc);

        gbc.gridx = 1;
        gbc.weightx = 1.0;
        JTextField hostnameField = new JTextField("localhost", 20);
        centerPanel.add(hostnameField, gbc);

        // 2. Port
        gbc.gridx = 0;
        gbc.gridy = 1;
        gbc.weightx = 0;
        centerPanel.add(new JLabel("Port:", SwingConstants.RIGHT), gbc);

        gbc.gridx = 1;
        gbc.weightx = 1.0;
        JTextField portField = new JTextField("23", 10);
        centerPanel.add(portField, gbc);

        // 3. LU Name
        gbc.gridx = 0;
        gbc.gridy = 2;
        gbc.weightx = 0;
        centerPanel.add(new JLabel("LU Name:", SwingConstants.RIGHT), gbc);

        gbc.gridx = 1;
        gbc.weightx = 1.0;
        JTextField luNameField = new JTextField("", 10);
        centerPanel.add(luNameField, gbc);

        // 4. Model
        gbc.gridx = 0;
        gbc.gridy = 3;
        gbc.weightx = 0;
        centerPanel.add(new JLabel("Model:", SwingConstants.RIGHT), gbc);

        gbc.gridx = 1;
        gbc.weightx = 1.0;
        JComboBox<String> modelChoice = new JComboBox<>();
        modelChoice.addItem("3278-2 (24x80)");
        modelChoice.addItem("3279-2 (24x80 Color)");
        modelChoice.addItem("3278-3 (32x80)");
        modelChoice.addItem("3279-3 (32x80 Color)");
        modelChoice.addItem("3278-4 (43x80)");
        modelChoice.addItem("3278-5 (27x132)");
        modelChoice.setSelectedIndex(3); // Default 3279-3
        centerPanel.add(modelChoice, gbc);

        // 5. TLS
        gbc.gridx = 1;
        gbc.gridy = 4;
        gbc.weightx = 1.0;
        JCheckBox tlsCheckbox = new JCheckBox("Use TLS/SSL encryption");
        centerPanel.add(tlsCheckbox, gbc);

        mainContainer.add(centerPanel, BorderLayout.CENTER);
        dialog.add(mainContainer, BorderLayout.CENTER);

        // --- Bottom Panel: Buttons ---
        JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT, 10, 10));
        JButton saveButton = new JButton("Save");
        JButton deleteButton = new JButton("Delete");
        JButton connectButton = new JButton("Connect");
        JButton cancelButton = new JButton("Cancel");

        deleteButton.setEnabled(false);

        bottomPanel.add(saveButton);
        bottomPanel.add(deleteButton);
        bottomPanel.add(Box.createHorizontalStrut(20));
        bottomPanel.add(connectButton);
        bottomPanel.add(cancelButton);

        dialog.add(bottomPanel, BorderLayout.SOUTH);
        dialog.getRootPane().setDefaultButton(connectButton);

        // --- Logic Handlers ---

        profileChoice.addItemListener(e -> {
            if (e.getStateChange() == ItemEvent.SELECTED) {
                String selected = (String) e.getItem();
                if (selected.equals("(New Connection)")) {
                    hostnameField.setText("localhost");
                    portField.setText("23");
                    luNameField.setText("");
                    modelChoice.setSelectedIndex(3);
                    tlsCheckbox.setSelected(false);
                    deleteButton.setEnabled(false);
                } else {
                    ConnectionProfile profile = savedProfiles.get(selected);
                    if (profile != null) {
                        hostnameField.setText(profile.hostname);
                        portField.setText(String.valueOf(profile.port));
                        luNameField.setText(profile.luName != null ? profile.luName : "");
                        tlsCheckbox.setSelected(profile.useTLS);
                        // Select model logic...
                        for (int i = 0; i < modelChoice.getItemCount(); i++) {
                            if (modelChoice.getItemAt(i).startsWith(profile.model)) {
                                modelChoice.setSelectedIndex(i);
                                break;
                            }
                        }
                        deleteButton.setEnabled(true);
                    }
                }
            }
        });

        saveButton.addActionListener(e -> {
            String current = (String) profileChoice.getSelectedItem();
            String defaultName = current.equals("(New Connection)") ? "" : current;
            String name = JOptionPane.showInputDialog(dialog, "Profile Name:", defaultName);

            if (name != null && !name.trim().isEmpty()) {
                String host = hostnameField.getText().trim();
                int port = 23;
                try { port = Integer.parseInt(portField.getText().trim()); } catch (Exception ex) {}
                String modStr = (String) modelChoice.getSelectedItem();
                String model = modStr.split(" ")[0];
                String lu = luNameField.getText().trim();
                boolean tls = tlsCheckbox.isSelected();

                savedProfiles.put(name, new ConnectionProfile(name, host, port, model, lu, tls));
                saveProfiles();

                // Refresh Dropdown
                boolean exists = false;
                for (int i = 0; i < profileChoice.getItemCount(); i++) {
                    if (profileChoice.getItemAt(i).equals(name)) exists = true;
                }
                if (!exists) profileChoice.addItem(name);
                profileChoice.setSelectedItem(name);
            }
        });

        deleteButton.addActionListener(e -> {
            String selected = (String) profileChoice.getSelectedItem();
            if (!selected.equals("(New Connection)")) {
                int confirm = JOptionPane.showConfirmDialog(dialog, "Delete profile '" + selected + "'?",
                        "Confirm Delete", JOptionPane.YES_NO_OPTION);
                if (confirm == JOptionPane.YES_OPTION) {
                    savedProfiles.remove(selected);
                    saveProfiles();
                    profileChoice.removeItem(selected);
                    profileChoice.setSelectedIndex(0);
                }
            }
        });

        // Connect Logic - Adapted for Tabs
     // Connect Logic - Adapted for Tabs
        final TN3270Emulator targetWindow = activeWindow;
        connectButton.addActionListener(e -> {
            String host = hostnameField.getText().trim();
            if (host.isEmpty()) host = "localhost";
            int port = 23;
            try { port = Integer.parseInt(portField.getText().trim()); } catch (Exception ex) {}

            String modStr = (String) modelChoice.getSelectedItem();
            String model = modStr.split(" ")[0]; // Get "3279-3" from string
            String lu = luNameField.getText().trim();
            boolean tls = tlsCheckbox.isSelected();

            dialog.dispose();

            if (targetWindow != null) {
                // If we have an active window, add a new tab
                targetWindow.openNewSession(host, port, model, lu, tls);
            } else {
                // No active window (shouldn't happen if launched normally), create new frame
                TN3270Emulator emu = new TN3270Emulator(model);
                emu.openNewSession(host, port, model, lu, tls);
            }
        });

        cancelButton.addActionListener(e -> dialog.dispose());

        dialog.pack();
        dialog.setLocationRelativeTo(activeWindow);
        dialog.setVisible(true);
    }

    private void showAboutDialog() {
        JOptionPane.showMessageDialog(this, "TN3270 Emulator\nVersion 2.0 (Tabbed)\n\n" +
                "A modern TN3270/TN3270E emulator with:\n" +
                "- TLS/SSL Encryption & IND$FILE Transfer\n" +
                "- AI Assistant with Context Awareness\n" +
                "- Visual Keyboard Mapping & Macros\n" +
                "- Tabbed Sessions",
                "About", JOptionPane.INFORMATION_MESSAGE);
    }

    private void showKeyboardReference() {
        JDialog dialog = new JDialog(this, "Keyboard Reference", false);
        dialog.setLayout(new BorderLayout());
        JTextArea textArea = new JTextArea(20, 50);
        textArea.setEditable(false);
        textArea.setFont(new Font("Monospaced", Font.PLAIN, 12));
        textArea.setMargin(new Insets(10, 10, 10, 10));
        
        textArea.setText("TN3270 KEYBOARD REFERENCE\n" +
                         "=========================\n\n" +
                         "F1-F12       PF1-PF12\n" +
                         "Shift+F1-12  PF13-PF24\n" +
                         "Enter        Send AID (Enter)\n" +
                         "Ctrl+C       Copy\n" +
                         "Ctrl+V       Paste\n" +
                         "Ctrl+A       Select All\n" +
                         "Ctrl+Shift+A Ask AI\n");
        
        dialog.add(new JScrollPane(textArea), BorderLayout.CENTER);
        JPanel p = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton b = new JButton("Close");
        b.addActionListener(e -> dialog.dispose());
        p.add(b);
        dialog.add(p, BorderLayout.SOUTH);
        dialog.pack();
        dialog.setLocationRelativeTo(this);
        dialog.setVisible(true);
    }

    // =======================================================================
    // MENU BAR CREATION
    // =======================================================================

    private void createMenuBar() {
        // 1. Use JMenuBar (Swing)
        JMenuBar menuBar = new JMenuBar();

        // Helper to determine Command (Mac) vs Ctrl (Windows/Linux)
        int shortcutKey = Toolkit.getDefaultToolkit().getMenuShortcutKeyMaskEx();

        // ===== FILE MENU =====
        JMenu fileMenu = new JMenu("File");

        JMenuItem newConnItem = new JMenuItem("New Connection...");
        // Swing Shortcut Syntax:
        newConnItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_N, shortcutKey));
        newConnItem.addActionListener(e -> showConnectionDialog());
        fileMenu.add(newConnItem);

        fileMenu.addSeparator();

        JMenuItem uploadItem = new JMenuItem("Upload to Host...");
        uploadItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_U, shortcutKey));
        uploadItem.addActionListener(e -> showFileTransferDialog(false));
        fileMenu.add(uploadItem);

        JMenuItem downloadItem = new JMenuItem("Download from Host...");
        downloadItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_D, shortcutKey));
        downloadItem.addActionListener(e -> showFileTransferDialog(true));
        fileMenu.add(downloadItem);

        fileMenu.addSeparator();

        JMenuItem disconnectItem = new JMenuItem("Disconnect");
        disconnectItem.addActionListener(e -> disconnect());
        fileMenu.add(disconnectItem);

        JMenuItem reconnectItem = new JMenuItem("Reconnect");
        reconnectItem.addActionListener(e -> reconnect());
        fileMenu.add(reconnectItem);

        fileMenu.addSeparator();

        JMenuItem exitItem = new JMenuItem("Exit");
        exitItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_Q, shortcutKey));
        exitItem.addActionListener(e -> {
            // Close logic handled by windowClosing listener
            dispatchEvent(new WindowEvent(this, WindowEvent.WINDOW_CLOSING));
        });
        fileMenu.add(exitItem);

        menuBar.add(fileMenu);

        // ===== EDIT MENU =====
        JMenu editMenu = new JMenu("Edit");
        
        // 1. COPY
        String copyLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Copy    \u2318C"   // Mac: âŒ˜C
                : "Copy    Ctrl+C";   // Win/Linux: Ctrl+C

        JMenuItem copyItem = new JMenuItem(copyLabel);
        copyItem.addActionListener(e -> copySelection());
        editMenu.add(copyItem);
        
        // 2. PASTE
        String pasteLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Paste    \u2318V" 
                : "Paste    Ctrl+V";

        JMenuItem pasteItem = new JMenuItem(pasteLabel);
        pasteItem.addActionListener(e -> pasteFromClipboard());
        editMenu.add(pasteItem);

        editMenu.addSeparator();

        // 3. SELECT ALL
        String selectAllLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Select All    \u2318A" 
                : "Select All    Ctrl+A";

        JMenuItem selectAllItem = new JMenuItem(selectAllLabel);
        selectAllItem.addActionListener(e -> selectAll());
        editMenu.add(selectAllItem);

        editMenu.addSeparator();

        // 4. ASK AI
        String aiLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Ask AI    \u21E7\u2318A" // Shift+Cmd+A
                : "Ask AI    Ctrl+Shift+A";
        
        JMenuItem askAIItem = new JMenuItem(aiLabel);
        askAIItem.addActionListener(e -> {
            TN3270Session session = getCurrentSession();
            if (session != null) {
                // Call the session's AI handling logic
                session.showAIChatDialog(this, session.getSelectedText());
            }
        });
        editMenu.add(askAIItem);

        menuBar.add(editMenu);

        // ===== VIEW MENU =====
        JMenu viewMenu = new JMenu("View");

        JCheckBoxMenuItem showKeyboardItem = new JCheckBoxMenuItem("Show Keyboard Panel", true);
        showKeyboardItem.addItemListener(e -> {
            keyboardPanel.setVisible(showKeyboardItem.getState());
            revalidate();
            repaint();
        });
        viewMenu.add(showKeyboardItem);

        viewMenu.addSeparator();

        JMenuItem fontSizeItem = new JMenuItem("Font Size...");
        fontSizeItem.addActionListener(e -> showFontSizeDialog());
        viewMenu.add(fontSizeItem);

        JMenuItem colorSchemeItem = new JMenuItem("Color Scheme...");
        colorSchemeItem.addActionListener(e -> showColorSchemeDialog());
        viewMenu.add(colorSchemeItem);

        menuBar.add(viewMenu);

        // ===== SETTINGS MENU =====
        JMenu settingsMenu = new JMenu("Settings");

        JMenuItem keyboardMapItem = new JMenuItem("Keyboard Mapping...");
        keyboardMapItem.addActionListener(e -> showKeyboardMappingDialog());
        settingsMenu.add(keyboardMapItem);

        JMenuItem terminalSettingsItem = new JMenuItem("Terminal Settings...");
        terminalSettingsItem.addActionListener(e -> showTerminalSettingsDialog());
        settingsMenu.add(terminalSettingsItem);

        menuBar.add(settingsMenu);

        // ===== HELP MENU =====
        JMenu helpMenu = new JMenu("Help");

        JMenuItem aboutItem = new JMenuItem("About");
        aboutItem.addActionListener(e -> showAboutDialog());
        helpMenu.add(aboutItem);

        JMenuItem keyboardHelpItem = new JMenuItem("Keyboard Reference");
        keyboardHelpItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_F1, 0));
        keyboardHelpItem.addActionListener(e -> showKeyboardReference());
        helpMenu.add(keyboardHelpItem);

        menuBar.add(helpMenu);

        setJMenuBar(menuBar);
    }

    // =======================================================================
    // DELEGATE METHODS (Route to Active Session)
    // =======================================================================

    public void disconnect() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.disconnect();
        }
    }

    public void reconnect() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.reconnect();
        }
    }

    public void copySelection() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.copySelection();
        }
    }

    public void pasteFromClipboard() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.pasteFromClipboard();
        }
    }

    public void selectAll() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.selectAll();
        }
    }

    public String getSelectedText() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            return session.getSelectedText();
        }
        return "";
    }

    // --- Dialog Delegates ---

    public void showFileTransferDialog(boolean isDownload) {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.showFileTransferDialog(isDownload);
        }
    }

    public void showFontSizeDialog() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.showFontSizeDialog();
        }
    }

    public void showColorSchemeDialog() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.showColorSchemeDialog();
        }
    }

    public void showKeyboardMappingDialog() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.showKeyboardMappingDialog();
        }
    }

    public void showTerminalSettingsDialog() {
        TN3270Session session = getCurrentSession();
        if (session != null) {
            session.showTerminalSettingsDialog();
        }
    }
    
 // =======================================================================
    // INNER CLASS: EnhancedRibbonToolbar
    // =======================================================================

    class EnhancedRibbonToolbar extends JPanel {
        private TN3270Emulator emulator;

        public EnhancedRibbonToolbar(TN3270Emulator emulator) {
            this.emulator = emulator;
            
            // BorderLayout ensures we fill the width of the Frame
            setLayout(new BorderLayout());
            setBackground(new Color(245, 245, 245));
            
            // Use a MatteBorder for the bottom line - guarantees full width stretch
            setBorder(new MatteBorder(0, 0, 1, 0, new Color(200, 200, 200)));

            // Button Container
            // FlowLayout.LEFT ensures buttons stay packed to the left
            JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 2, 2));
            buttonPanel.setOpaque(false);

            // --- Connection Group ---
            buttonPanel.add(createButton("new_conn", "New Connection", e -> TN3270Emulator.showConnectionDialog()));
            buttonPanel.add(createButton("disconnect", "Disconnect", e -> emulator.disconnect()));
            buttonPanel.add(createButton("reconnect", "Reconnect", e -> emulator.reconnect()));
            buttonPanel.add(createSeparator());

            // --- File Transfer Group ---
            buttonPanel.add(createButton("upload", "Upload to Host", e -> emulator.showFileTransferDialog(false)));
            buttonPanel.add(createButton("download", "Download from Host", e -> emulator.showFileTransferDialog(true)));
            buttonPanel.add(createSeparator());

            // --- Edit Group ---
            buttonPanel.add(createButton("copy", "Copy", e -> emulator.copySelection()));
            buttonPanel.add(createButton("paste", "Paste", e -> emulator.pasteFromClipboard()));
            buttonPanel.add(createButton("select_all", "Select All", e -> emulator.selectAll()));
            buttonPanel.add(createSeparator());

            // --- Settings/View Group ---
            buttonPanel.add(createButton("colors", "Color Scheme", e -> emulator.showColorSchemeDialog()));
            buttonPanel.add(createButton("font", "Font Size", e -> emulator.showFontSizeDialog()));
            buttonPanel.add(createButton("keyboard", "Keyboard Mapping", e -> emulator.showKeyboardMappingDialog()));
            buttonPanel.add(createButton("terminal", "Terminal Settings", e -> emulator.showTerminalSettingsDialog()));
            
            // --- AI Group ---
            buttonPanel.add(createSeparator());
            buttonPanel.add(createButton("ai_sparkles", "Ask AI", 
                e -> {
                    TN3270Session s = emulator.getCurrentSession();
                    if (s != null) s.showAIChatDialog(emulator, s.getSelectedText());
                }));
            
            add(buttonPanel, BorderLayout.CENTER);
        }

        private Component createSeparator() {
            JSeparator s = new JSeparator(SwingConstants.VERTICAL);
            s.setPreferredSize(new Dimension(2, 24));
            JPanel p = new JPanel(new FlowLayout(FlowLayout.CENTER, 5, 0));
            p.setOpaque(false);
            p.add(s);
            return p;
        }

        private JButton createButton(String iconName, String toolTip, ActionListener action) {
            BufferedImage img = createEnhancedIcon(iconName);
            ImageIcon icon = new ImageIcon(img);

            JButton btn = new JButton(icon);
            btn.setToolTipText(toolTip);
            btn.addActionListener(action);

            // Fixed size to prevent shrinking/jumping
            Dimension fixedSize = new Dimension(40, 34);
            btn.setPreferredSize(fixedSize);
            btn.setMinimumSize(fixedSize);
            btn.setMaximumSize(fixedSize);

            btn.setFocusable(false);
            btn.setBorderPainted(false);
            btn.setContentAreaFilled(false);
            
            // Invisible border for spacing
            Border emptyBorder = BorderFactory.createEmptyBorder(1, 1, 1, 1);
            Border hoverBorder = BorderFactory.createLineBorder(new Color(180, 200, 220), 1);
            btn.setBorder(emptyBorder);

            btn.addMouseListener(new java.awt.event.MouseAdapter() {
                public void mouseEntered(java.awt.event.MouseEvent evt) {
                    if (btn.isEnabled()) {
                        btn.setContentAreaFilled(true);
                        btn.setBackground(new Color(225, 230, 240));
                        btn.setBorderPainted(true);
                        btn.setBorder(hoverBorder);
                    }
                }
                public void mouseExited(java.awt.event.MouseEvent evt) {
                    btn.setContentAreaFilled(false);
                    btn.setBorderPainted(false);
                    btn.setBorder(emptyBorder);
                }
            });
            return btn;
        }

        private BufferedImage createEnhancedIcon(String name) {
            BufferedImage img = new BufferedImage(32, 32, BufferedImage.TYPE_INT_ARGB);
            Graphics2D g = img.createGraphics();
            g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
            g.setStroke(new BasicStroke(2.0f, BasicStroke.CAP_ROUND, BasicStroke.JOIN_ROUND));

            switch (name) {
                case "new_conn":
                    g.setColor(new Color(70, 130, 180));
                    g.fillRoundRect(4, 8, 24, 16, 4, 4);
                    g.setColor(new Color(100, 160, 210));
                    g.fillRoundRect(6, 10, 20, 12, 2, 2);
                    g.setColor(new Color(50, 180, 50));
                    g.fillOval(24, 4, 6, 6);
                    break;
                case "disconnect":
                    g.setColor(new Color(180, 70, 70));
                    g.fillRoundRect(4, 8, 24, 16, 4, 4);
                    g.setColor(Color.WHITE);
                    g.setStroke(new BasicStroke(2.5f));
                    g.drawLine(10, 14, 22, 20);
                    g.drawLine(22, 14, 10, 20);
                    break;
                case "reconnect":
                    g.setColor(new Color(70, 130, 180));
                    g.drawArc(8, 8, 16, 16, 45, 270);
                    int[] xPoints = { 24, 28, 24 };
                    int[] yPoints = { 12, 16, 20 };
                    g.fillPolygon(xPoints, yPoints, 3);
                    break;
                case "upload":
                    g.setColor(new Color(50, 120, 200));
                    g.fillRect(10, 18, 12, 10);
                    g.setColor(new Color(80, 150, 230));
                    g.fillPolygon(new int[]{16, 8, 16, 16, 24, 16}, new int[]{6, 16, 16, 26, 16, 6}, 6);
                    break;
                case "download":
                    g.setColor(new Color(50, 120, 200));
                    g.fillRect(10, 4, 12, 10);
                    g.setColor(new Color(80, 150, 230));
                    g.fillPolygon(new int[]{16, 8, 16, 16, 24, 16}, new int[]{26, 16, 16, 6, 16, 26}, 6);
                    break;
                case "copy":
                    g.setColor(new Color(100, 100, 100));
                    g.fillRoundRect(8, 10, 14, 18, 2, 2);
                    g.setColor(new Color(150, 150, 150));
                    g.fillRoundRect(12, 6, 14, 18, 2, 2);
                    g.setColor(Color.WHITE);
                    g.drawLine(14, 10, 22, 10); g.drawLine(14, 14, 22, 14); g.drawLine(14, 18, 22, 18);
                    break;
                case "paste":
                    g.setColor(new Color(120, 120, 120));
                    g.fillRoundRect(8, 8, 16, 20, 2, 2);
                    g.setColor(new Color(180, 180, 180));
                    g.fillRoundRect(12, 4, 8, 6, 2, 2);
                    g.setColor(Color.WHITE);
                    g.fillRect(11, 12, 10, 2); g.fillRect(11, 16, 10, 2); g.fillRect(11, 20, 10, 2);
                    break;
                case "select_all":
                    g.setColor(new Color(100, 150, 255));
                    g.setStroke(new BasicStroke(2.0f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER, 10.0f, new float[]{4.0f}, 0.0f));
                    g.drawRect(6, 6, 20, 20);
                    g.setColor(new Color(100, 150, 255, 50));
                    g.fillRect(7, 7, 18, 18);
                    break;
                case "colors":
                    g.setColor(Color.RED); g.fillOval(6, 6, 10, 10);
                    g.setColor(Color.GREEN); g.fillOval(18, 6, 10, 10);
                    g.setColor(Color.BLUE); g.fillOval(6, 18, 10, 10);
                    g.setColor(Color.YELLOW); g.fillOval(18, 18, 10, 10);
                    break;
                case "font":
                    g.setColor(Color.BLACK);
                    g.setFont(new Font("SansSerif", Font.BOLD, 20));
                    g.drawString("Aa", 6, 24);
                    break;
                case "keyboard":
                    g.setColor(new Color(80, 80, 80));
                    g.fillRoundRect(4, 10, 24, 16, 3, 3);
                    g.setColor(new Color(200, 200, 200));
                    for(int i=0; i<3; i++) for(int j=0; j<6; j++) g.fillRect(6+j*4, 12+i*4, 2, 3);
                    break;
                case "terminal":
                    g.setColor(new Color(60, 60, 60));
                    g.fillRoundRect(4, 4, 24, 20, 4, 4);
                    g.setColor(new Color(50, 200, 50));
                    g.fillRect(7, 7, 18, 14);
                    g.setColor(new Color(60, 60, 60));
                    g.fillRect(10, 24, 12, 3); g.fillRect(8, 27, 16, 2);
                    break;
                case "ai_sparkles":
                    g.setColor(new Color(85, 80, 230));
                    g.fillRoundRect(1, 1, 22, 17, 7, 7);
                    g.fillPolygon(new int[]{5, 5, 1}, new int[]{17, 23, 17}, 3);
                    g.setColor(Color.WHITE);
                    g.fillPolygon(new int[]{12, 17, 12, 7}, new int[]{5, 10, 15, 10}, 4);
                    g.fillPolygon(new int[]{18, 20, 18, 16}, new int[]{4, 6, 8, 6}, 4);
                    break;
            }
            g.dispose();
            return img;
        }
    }

    // =======================================================================
    // INNER CLASS: ModernKeyboardPanel
    // =======================================================================

    class ModernKeyboardPanel extends JPanel {
        private TN3270Emulator emulator;

        // Colors
        private final Color COL_FKEY     = new Color(70, 130, 180);  // Steel Blue
        private final Color COL_CLEAR    = new Color(150, 50, 50);   // Red
        private final Color COL_PA       = new Color(180, 130, 70);  // Bronze
        private final Color COL_ENTER    = new Color(50, 150, 50);   // Green
        private final Color COL_RESET    = new Color(100, 100, 100); // Dark Grey
        private final Color COL_INSERT   = new Color(100, 100, 150); // Blue-Grey
        private final Color COL_ERASE    = new Color(120, 100, 100); // Red-Grey
        private final Color COL_NEWLINE  = new Color(100, 120, 100); // Green-Grey
        private final Color COL_TEXT     = Color.WHITE;

        public ModernKeyboardPanel(TN3270Emulator emulator) {
            this.emulator = emulator;
            
            setLayout(new BorderLayout());
            setBackground(new Color(50, 50, 55));
            setBorder(new EmptyBorder(2, 2, 2, 2));
            
            // --- LEFT: KEYS ---
            JPanel keysPanel = new JPanel(new GridBagLayout());
            keysPanel.setOpaque(false);
            GridBagConstraints gbc = new GridBagConstraints();
            gbc.gridx = 0; 
            gbc.weightx = 1.0;
            gbc.fill = GridBagConstraints.HORIZONTAL;
            gbc.insets = new Insets(0, 0, 2, 0);

            // Row 1: F1-F12
            gbc.gridy = 0;
            JPanel row1 = new JPanel(new GridLayout(1, 12, 1, 1));
            row1.setOpaque(false);
            for (int i = 1; i <= 12; i++) {
                // Accessing static constants from TN3270Session
                final byte aid = (i <= 9) ? (byte)(TN3270Session.AID_PF1 + i - 1) :
                                 (i == 10)? TN3270Session.AID_PF10 : 
                                 (i == 11)? TN3270Session.AID_PF11 : TN3270Session.AID_PF12;
                row1.add(createButton("F" + i, COL_FKEY, e -> sendAID(aid)));
            }
            keysPanel.add(row1, gbc);

            // Row 2: F13-F24
            gbc.gridy = 1;
            JPanel row2 = new JPanel(new GridLayout(1, 12, 1, 1));
            row2.setOpaque(false);
            for (int i = 13; i <= 24; i++) {
                final int shift = i - 13; 
                final byte aid;
                if (shift <= 8) aid = (byte)(TN3270Session.AID_PF13 + shift); 
                else if (shift == 9) aid = TN3270Session.AID_PF22;
                else if (shift == 10) aid = TN3270Session.AID_PF23;
                else aid = TN3270Session.AID_PF24;
                row2.add(createButton("F" + i, COL_FKEY, e -> sendAID(aid)));
            }
            keysPanel.add(row2, gbc);

            // Row 3: Action Keys (9 Buttons)
            gbc.gridy = 2;
            gbc.insets = new Insets(0, 0, 0, 0);
            JPanel row3 = new JPanel(new GridLayout(1, 9, 1, 1));
            row3.setOpaque(false);

            row3.add(createButton("Clear", COL_CLEAR, e -> {
                TN3270Session s = emulator.getCurrentSession();
                if (s != null && !s.keyboardLocked && s.isConnected()) {
                    s.sendAID(TN3270Session.AID_CLEAR);
                }
            }));
            
            row3.add(createButton("PA1", COL_PA, e -> sendAID(TN3270Session.AID_PA1)));
            row3.add(createButton("PA2", COL_PA, e -> sendAID(TN3270Session.AID_PA2)));
            row3.add(createButton("PA3", COL_PA, e -> sendAID(TN3270Session.AID_PA3))); 
            
            row3.add(createButton("Reset", COL_RESET, e -> {
                TN3270Session s = emulator.getCurrentSession();
                if(s != null) {
                    s.keyboardLocked = false;
                    s.repaint();
                    s.requestFocusInWindow(); 
                }
            }));
            
            row3.add(createButton("Insert", COL_INSERT, e -> {
                 TN3270Session s = emulator.getCurrentSession();
                 if(s != null) s.toggleInsertMode();
            }));
            
            row3.add(createButton("EraseEOF", COL_ERASE, e -> {
                TN3270Session s = emulator.getCurrentSession();
                if(s != null && !s.keyboardLocked && s.isConnected()) {
                    s.eraseToEndOfField();
                    s.requestFocusInWindow();
                }
            }));
            
            row3.add(createButton("Newline", COL_NEWLINE, e -> {
                 TN3270Session s = emulator.getCurrentSession();
                 if(s != null && !s.keyboardLocked && s.isConnected()) {
                     s.tabToNextField();
                     s.requestFocusInWindow();
                 }
            }));
            
            row3.add(createButton("Enter", COL_ENTER, e -> sendAID(TN3270Session.AID_ENTER)));
            
            keysPanel.add(row3, gbc);
            add(keysPanel, BorderLayout.CENTER);

            // --- RIGHT: STATUS PANEL ---
            JPanel statusPanel = createStatusPanel();
            add(statusPanel, BorderLayout.EAST);
        }
        
        private JPanel createStatusPanel() {
            JPanel panel = new JPanel(new GridLayout(3, 1, 2, 2));
            panel.setBackground(new Color(50, 50, 55));
            panel.setBorder(new EmptyBorder(0, 3, 0, 0));
            panel.setPreferredSize(new Dimension(72, 0));

            // 1. Ready/Wait Status
            JPanel kbStatus = new JPanel() {
                @Override protected void paintComponent(Graphics g) {
                    super.paintComponent(g);
                    g.setFont(new Font("SansSerif", Font.BOLD, 9));
                    
                    TN3270Session s = emulator.getCurrentSession();
                    boolean locked = (s != null && s.keyboardLocked);
                    
                    if (locked) {
                        g.setColor(new Color(255, 200, 0)); 
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.BLACK);
                        g.drawString("X WAIT", 18, 18);
                    } else {
                        g.setColor(new Color(0, 180, 60)); 
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.WHITE);
                        g.drawString("READY", 20, 18);
                    }
                }
            };
            panel.add(kbStatus);

            // 2. Connection Status
            JPanel connStatus = new JPanel() {
                @Override protected void paintComponent(Graphics g) {
                    super.paintComponent(g);
                    g.setFont(new Font("SansSerif", Font.BOLD, 9));
                    
                    TN3270Session s = emulator.getCurrentSession();
                    boolean connected = (s != null && s.isConnected());

                    if (connected) {
                        g.setColor(new Color(70, 70, 75));
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.CYAN);
                        g.drawString("ONLINE", 18, 18);
                    } else {
                        g.setColor(new Color(40, 40, 45));
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.GRAY);
                        g.drawString("OFFLINE", 16, 18);
                    }
                }
            };
            panel.add(connStatus);

            // 3. Insert Mode
            JPanel insStatus = new JPanel() {
                @Override protected void paintComponent(Graphics g) {
                    super.paintComponent(g);
                    g.setFont(new Font("SansSerif", Font.BOLD, 9));
                    g.setColor(new Color(40, 40, 45));
                    g.fillRect(0, 0, getWidth(), getHeight());
                    
                    TN3270Session s = emulator.getCurrentSession();
                    boolean insert = (s != null && s.insertMode);

                    if (insert) {
                        g.setColor(Color.ORANGE);
                        g.drawString("INS", 26, 18);
                        g.fillRect(12, 8, 8, 2); g.fillRect(15, 5, 2, 8);
                    } else {
                        g.setColor(Color.LIGHT_GRAY);
                        g.drawString("OVR", 26, 18);
                    }
                }
            };
            panel.add(insStatus);
            
            // Timer to refresh status lights
            javax.swing.Timer t = new javax.swing.Timer(200, e -> panel.repaint());
            t.start();
            return panel;
        }

        private void sendAID(byte aid) {
            TN3270Session s = emulator.getCurrentSession();
            if (s != null && !s.keyboardLocked && s.isConnected()) {
                s.sendAID(aid);
                s.requestFocusInWindow();
            }
        }

        private JButton createButton(String text, Color bg, ActionListener l) {
            JButton b = new JButton(text) {
                @Override public Dimension getPreferredSize() {
                    FontMetrics fm = getFontMetrics(getFont());
                    return new Dimension(fm.stringWidth(getText()) + 6, 28);
                }

                @Override protected void paintComponent(Graphics g) {
                    Graphics2D g2 = (Graphics2D) g.create();
                    g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    
                    Color fill = bg;
                    if (getModel().isPressed()) fill = bg.darker();
                    else if (getModel().isRollover()) fill = bg.brighter();
                    
                    g2.setColor(fill);
                    g2.fillRoundRect(0, 0, getWidth()-1, getHeight()-1, 8, 8);
                    
                    g2.setColor(bg.darker());
                    g2.drawRoundRect(0, 0, getWidth()-1, getHeight()-1, 8, 8);
                    
                    g2.setColor(COL_TEXT);
                    g2.setFont(getFont());
                    FontMetrics fm = g2.getFontMetrics();
                    int x = (getWidth() - fm.stringWidth(getText())) / 2;
                    int y = (getHeight() + fm.getAscent()) / 2 - 2;
                    g2.drawString(getText(), x, y);
                    
                    g2.dispose();
                }
            };
            
            b.setFont(new Font("SansSerif", Font.BOLD, 10)); 
            b.setMargin(new Insets(0, 0, 0, 0)); 
            b.setFocusable(false); 
            b.setContentAreaFilled(false); 
            b.setBorderPainted(false);
            
            if (l != null) b.addActionListener(l);
            
            return b;
        }
    }
    
 // =======================================================================
    // INNER CLASSES: KEYBOARD MAPPING UI
    // =======================================================================

    /* -------------------- Special Character Palette -------------------- */
    static class SpecialCharPalette extends JDialog {
        private String selectedChar = null;

        // Common 3270 / EBCDIC symbols (31 items)
        private final String[] SYMBOLS = { "Â¬", "Â¢", "Â¦", "|", "\\", "[", "]", "{", "}", "Î¼", "ÃŸ", "!", "@", "#", "$",
                "%", "^", "&", "*", "(", ")", "_", "+", "-", "=", "<", ">", "?", "/", "~", "`" };

        private final String[] DESCRIPTIONS = { "Not Sign", "Cent", "Broken Bar", "Solid Pipe", "Backslash",
                "Left Bracket", "Right Bracket", "Left Brace", "Right Brace", "Mu", "Eszett", "Exclamation", "At",
                "Hash", "Dollar", "Percent", "Caret", "Ampersand", "Star", "L-Paren", "R-Paren", "Underscore", "Plus",
                "Minus", "Equals", "Less", "Greater", "Question", "Slash", "Tilde", "Backtick" };

        public SpecialCharPalette(Dialog owner) {
            super(owner, "Select Character", true);
            setLayout(new BorderLayout());
            setSize(550, 400); // Slightly larger to accommodate the grid comfortably
            setLocationRelativeTo(owner);

            JLabel lbl = new JLabel("Select a symbol or enter a Hex code:", SwingConstants.CENTER);
            lbl.setBorder(new EmptyBorder(10, 10, 10, 10));
            add(lbl, BorderLayout.NORTH);

            // 4 Columns x 8 Rows = 32 Slots.
            JPanel grid = new JPanel(new GridLayout(0, 4, 5, 5));
            grid.setBorder(new EmptyBorder(10, 10, 10, 10));

            // 1. Add Standard Symbols
            for (int i = 0; i < SYMBOLS.length; i++) {
                final String s = SYMBOLS[i];
                final String d = DESCRIPTIONS[i];
                JButton btn = new JButton(s);
                btn.setFont(new Font("Monospaced", Font.BOLD, 16));
                btn.setToolTipText(d);
                btn.addActionListener(e -> {
                    selectedChar = s;
                    dispose();
                });
                grid.add(btn);
            }

            // 2. Add Hex Input Button (The 32nd Slot)
            JButton hexBtn = new JButton(
                    "<html><center><font size='3'>Hex</font><br><font size='2'>Code...</font></center></html>");
            hexBtn.setFont(new Font("SansSerif", Font.PLAIN, 10));
            hexBtn.setBackground(new Color(230, 240, 255)); // Pale blue to distinguish it
            hexBtn.setToolTipText("Enter a specific Unicode character by Hex value (e.g. 00A5)");

            hexBtn.addActionListener(e -> {
                String input = JOptionPane.showInputDialog(this, "Enter 4-digit Hex Code (e.g. 00AC for Â¬):",
                        "Hex Input", JOptionPane.PLAIN_MESSAGE);

                if (input != null && !input.trim().isEmpty()) {
                    try {
                        // Clean input (handle 0x, U+, etc)
                        String clean = input.trim().replace("0x", "").replace("U+", "").replace("u+", "");
                        int codePoint = Integer.parseInt(clean, 16);
                        selectedChar = String.valueOf((char) codePoint);
                        dispose();
                    } catch (NumberFormatException ex) {
                        JOptionPane.showMessageDialog(this,
                                "Invalid Hex Code. Please enter hexadecimal numbers (0-9, A-F).", "Error",
                                JOptionPane.ERROR_MESSAGE);
                    }
                }
            });
            grid.add(hexBtn);

            JButton cancel = new JButton("Cancel");
            cancel.addActionListener(e -> dispose());

            add(new JScrollPane(grid), BorderLayout.CENTER);
            add(cancel, BorderLayout.SOUTH);
        }

        public String getSelected() {
            return selectedChar;
        }
    }

    /* -------------------- Keyboard Settings Dialog -------------------- */
    static class KeyboardSettingsDialog extends JDialog {
        private final TN3270Session session;
        private final Map<Integer, TN3270Session.KeyMapping> tempKeyMap;
        private final Map<Character, Character> tempCharMap;
        private final JLabel statusLabel;

        // --- 3270 Visual Tab State ---
        private boolean shift3270Active = false;
        private final List<JButton> buttons3270 = new ArrayList<>();
        private JPanel panel3270;

        // --- PC Visual Tab State ---
        private boolean shiftPCActive = false;
        private final List<JButton> buttonsPC = new ArrayList<>();
        private JPanel panelPC;

        // Style Backups
        private Border defaultBorder;
        private Color defaultBg;
        private boolean stylesCaptured = false;

        // Layout Constants
        private static final int KW = 60;
        private static final int KH = 50;
        private static final int GAP = 5;
        private static final int START_X = 20;
        private static final int START_Y = 20;

        // PF Constants copied from session for local usage
        private static final byte[] PF_AID_REF = new byte[] { 
            (byte)0xF1, (byte)0xF2, (byte)0xF3, (byte)0xF4, (byte)0xF5, (byte)0xF6, (byte)0xF7, (byte)0xF8, (byte)0xF9, 
            (byte)0x7A, (byte)0x7B, (byte)0x7C, (byte)0xC1, (byte)0xC2, (byte)0xC3, (byte)0xC4, (byte)0xC5, (byte)0xC6, 
            (byte)0xC7, (byte)0xC8, (byte)0xC9, (byte)0x4A, (byte)0x4B, (byte)0x4C 
        };

        public KeyboardSettingsDialog(Frame owner, TN3270Session session) {
            super(owner, "Keyboard Remapping", true);
            this.session = session;
            // Create copies of the maps to allow cancellation
            this.tempKeyMap = new HashMap<>(session.getKeyMap());
            this.tempCharMap = new HashMap<>(session.getInputCharMap());

            setLayout(new BorderLayout());

            // --- Header ---
            JPanel header = new JPanel(new FlowLayout(FlowLayout.LEFT));
            header.setBackground(new Color(45, 45, 48));
            JLabel title = new JLabel("Configure your keyboard interaction.");
            title.setForeground(Color.WHITE);
            title.setFont(new Font("SansSerif", Font.BOLD, 14));
            header.add(title);
            add(header, BorderLayout.NORTH);

            // --- Tabs ---
            JTabbedPane tabs = new JTabbedPane();
            tabs.addTab("1. Map 3270 Functions", null, create3270Panel(),
                    "Assign physical keys to 3270 functions (PF keys, Enter, Clear)");
            tabs.addTab("2. Translate PC Characters", null, createPCPanel(),
                    "Change what specific characters types (e.g. Map '^' to 'Â¬')");
            add(tabs, BorderLayout.CENTER);

            // --- Footer ---
            JPanel footer = new JPanel(new BorderLayout());
            footer.setBorder(new EmptyBorder(10, 10, 10, 10));

            statusLabel = new JLabel("Green Border = Mapped/Translated.");
            statusLabel.setForeground(Color.DARK_GRAY);

            JPanel btnPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
            JButton saveBtn = new JButton("Save & Close");
            JButton cancelBtn = new JButton("Cancel");
            JButton resetBtn = new JButton("Reset Defaults");

            saveBtn.addActionListener(e -> {
                session.getKeyMap().clear();
                session.getKeyMap().putAll(tempKeyMap);
                session.getInputCharMap().clear();
                session.getInputCharMap().putAll(tempCharMap);
                session.saveKeyMappings();
                dispose();
            });

            cancelBtn.addActionListener(e -> dispose());

            resetBtn.addActionListener(e -> {
                if (JOptionPane.showConfirmDialog(this, "Reset all mappings?", "Confirm",
                        JOptionPane.YES_NO_OPTION) == JOptionPane.YES_OPTION) {
                    tempKeyMap.clear();
                    tempCharMap.clear();
                    session.loadKeyMappings();
                    tempKeyMap.putAll(session.getKeyMap());
                    tempCharMap.putAll(session.getInputCharMap());
                    statusLabel.setText("Reset to defaults.");
                    refresh3270Visuals();
                    refreshPCVisuals();
                }
            });

            btnPanel.add(resetBtn);
            btnPanel.add(cancelBtn);
            btnPanel.add(saveBtn);

            footer.add(statusLabel, BorderLayout.WEST);
            footer.add(btnPanel, BorderLayout.EAST);
            add(footer, BorderLayout.SOUTH);

            // --- WINDOW SIZING LOGIC ---
            pack(); 
            // Safety: Ensure we didn't get bigger than the screen
            Dimension screen = Toolkit.getDefaultToolkit().getScreenSize();
            int w = Math.min(getWidth(), screen.width - 50);
            int h = Math.min(getHeight(), screen.height - 50);
            setSize(w, h);

            setLocationRelativeTo(owner);

            SwingUtilities.invokeLater(() -> {
                refresh3270Visuals();
                refreshPCVisuals();
            });
        }

        // ============================================================
        // TAB 1: 3270 DESTINATION MAPPER
        // ============================================================
        private JScrollPane create3270Panel() {
            panel3270 = new JPanel(null);
            panel3270.setPreferredSize(new Dimension(1220, 600));
            panel3270.setBackground(new Color(220, 225, 230));

            int x = START_X;
            int y = START_Y;
            int controlX = START_X + (15 * (KW + GAP)) + 40;

            // --- ROW 1: PF1 - PF12 ---
            for (int i = 1; i <= 12; i++) {
                byte aid = (i <= 9) ? (byte)(TN3270Session.AID_PF1 + i - 1) : 
                           (i == 10)? TN3270Session.AID_PF10 : (i == 11)? TN3270Session.AID_PF11 : TN3270Session.AID_PF12;
                add3270Button(panel3270, "PF" + i, aid, x, y, KW, KH);
                x += KW + GAP;
                if (i % 4 == 0)
                    x += (GAP * 2);
            }

            // PA Keys (Top Right)
            int paX = controlX;
            add3270Button(panel3270, "PA1", TN3270Session.AID_PA1, paX, y, KW, KH);
            add3270Button(panel3270, "PA2", TN3270Session.AID_PA2, paX + KW + GAP, y, KW, KH);
            add3270Button(panel3270, "PA3", TN3270Session.AID_PA3, paX + (KW + GAP) * 2, y, KW, KH);

            // --- ROW 2: PF13 - PF24 ---
            x = START_X;
            y += KH + GAP + 5;
            for (int i = 13; i <= 24; i++) {
                add3270Button(panel3270, "PF" + i, PF_AID_REF[i - 1], x, y, KW, KH);
                x += KW + GAP;
                if (i == 16 || i == 20)
                    x += (GAP * 2);
            }

            // CLEAR (Right Side)
            add3270Button(panel3270, "CLEAR", TN3270Session.AID_CLEAR, controlX, y, (KW * 3) + (GAP * 2), KH);

            // --- ROW 3: Numbers ---
            x = START_X;
            y += KH + GAP + 30;
            int row3Y = y;

            String[] r1Normal = { "Â¬", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=" };
            String[] r1Shift = { "~", "!", "@", "#", "$", "%", "Â¬", "&", "*", "(", ")", "_", "+" };

            for (int i = 0; i < r1Normal.length; i++) {
                add3270CharButton(panel3270, r1Normal[i], r1Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }
            add3270Button(panel3270, "Back", (byte) 0, x, y, KW * 2, KH);

            // Right Side: ATTN
            add3270Button(panel3270, "ATTN", TN3270Session.AID_ATTN, controlX, row3Y, 80, KH);

            // --- ROW 4: QWERTY ---
            y += KH + GAP;
            int row4Y = y;
            x = START_X;
            add3270Button(panel3270, "Tab", (byte) 0, x, y, (int) (KW * 1.5), KH);
            x += (int) (KW * 1.5) + GAP;

            String[] r2Normal = { "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\" };
            String[] r2Shift = { "Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "{", "}", "|" };
            for (int i = 0; i < r2Normal.length; i++) {
                add3270CharButton(panel3270, r2Normal[i], r2Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }

            // Right Side: SYS REQ
            add3270Button(panel3270, "SYS REQ", TN3270Session.AID_SYSREQ, controlX, row4Y, 80, KH);

            // --- ROW 5: ASDF ---
            y += KH + GAP;
            int row5Y = y;
            x = START_X;
            JToggleButton ctrlVis = new JToggleButton("Ctrl");
            ctrlVis.setBounds(x, y, (int) (KW * 1.8), KH);
            panel3270.add(ctrlVis);
            x += (int) (KW * 1.8) + GAP;

            String[] r3Normal = { "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'" };
            String[] r3Shift = { "A", "S", "D", "F", "G", "H", "J", "K", "L", ":", "\"" };
            for (int i = 0; i < r3Normal.length; i++) {
                add3270CharButton(panel3270, r3Normal[i], r3Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }
            add3270Button(panel3270, "Enter", TN3270Session.AID_ENTER, x, y, (int) (KW * 2.2), KH);

            // Right Side: RESET
            add3270Button(panel3270, "RESET", (byte) 0, controlX, row5Y, 80, KH);

            // --- ROW 6: ZXCV ---
            y += KH + GAP;
            int row6Y = y;
            x = START_X;
            JToggleButton shiftToggleL = new JToggleButton("Shift");
            shiftToggleL.setBounds(x, y, (int) (KW * 2.3), KH);
            shiftToggleL.addActionListener(e -> update3270ShiftState(shiftToggleL.isSelected()));
            panel3270.add(shiftToggleL);
            x += (int) (KW * 2.3) + GAP;

            String[] r4Normal = { "z", "x", "c", "v", "b", "n", "m", ",", ".", "/" };
            String[] r4Shift = { "Z", "X", "C", "V", "B", "N", "M", "<", ">", "?" };
            for (int i = 0; i < r4Normal.length; i++) {
                add3270CharButton(panel3270, r4Normal[i], r4Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }

            add3270Button(panel3270, "R-Shift", (byte) 0, x, y, (int) (KW * 2.7), KH);

            // Right Side: ERASE EOF
            add3270Button(panel3270, "EraseEOF", (byte) 0, controlX, row6Y, 80, KH);

            // --- ROW 7: Space ---
            y += KH + GAP;
            int row7Y = y;
            x = START_X + (KW * 4);
            add3270CharButton(panel3270, "Space", "Space", x, y, KW * 6, KH);

            // Right Side: NEWLINE
            add3270Button(panel3270, "NEWLINE", TN3270Session.AID_ENTER, controlX, row7Y, 80, KH);

            return new JScrollPane(panel3270);
        }

        // ============================================================
        // TAB 2: PC SOURCE MAPPER
        // ============================================================
        private JScrollPane createPCPanel() {
            panelPC = new JPanel(null);
            panelPC.setPreferredSize(new Dimension(1100, 400));
            panelPC.setBackground(new Color(240, 240, 245));

            int x = START_X;
            int y = START_Y + 50;

            JLabel help = new JLabel("<html><b>Visual PC Keyboard:</b> Click a character to translate it.<br>"
                    + "Example: Toggle Shift, Click '^', Select 'Â¬'.</html>");
            help.setBounds(START_X, 10, 800, 30);
            help.setFont(new Font("SansSerif", Font.PLAIN, 12));
            panelPC.add(help);

            // --- ROW 1: Numbers ---
            String[] pc1Normal = { "`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=" };
            String[] pc1Shift = { "~", "!", "@", "#", "$", "%", "^", "&", "*", "(", ")", "_", "+" };

            for (int i = 0; i < pc1Normal.length; i++) {
                addPCCharButton(panelPC, pc1Normal[i], pc1Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }
            addPCStubButton(panelPC, "Bksp", x, y, KW * 2, KH);

            // --- ROW 2: QWERTY ---
            y += KH + GAP;
            x = START_X;
            addPCStubButton(panelPC, "Tab", x, y, (int) (KW * 1.5), KH);
            x += (int) (KW * 1.5) + GAP;

            String[] pc2Normal = { "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\" };
            String[] pc2Shift = { "Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "{", "}", "|" };
            for (int i = 0; i < pc2Normal.length; i++) {
                addPCCharButton(panelPC, pc2Normal[i], pc2Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }

            // --- ROW 3: ASDF ---
            y += KH + GAP;
            x = START_X;
            addPCStubButton(panelPC, "Caps", x, y, (int) (KW * 1.8), KH);
            x += (int) (KW * 1.8) + GAP;

            String[] pc3Normal = { "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'" };
            String[] pc3Shift = { "A", "S", "D", "F", "G", "H", "J", "K", "L", ":", "\"" };
            for (int i = 0; i < pc3Normal.length; i++) {
                addPCCharButton(panelPC, pc3Normal[i], pc3Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }
            addPCStubButton(panelPC, "Enter", x, y, (int) (KW * 2.2), KH);

            // --- ROW 4: ZXCV ---
            y += KH + GAP;
            x = START_X;
            JToggleButton shiftPC = new JToggleButton("Shift");
            shiftPC.setBounds(x, y, (int) (KW * 2.3), KH);
            shiftPC.addActionListener(e -> updatePCShiftState(shiftPC.isSelected()));
            panelPC.add(shiftPC);
            x += (int) (KW * 2.3) + GAP;

            String[] pc4Normal = { "z", "x", "c", "v", "b", "n", "m", ",", ".", "/" };
            String[] pc4Shift = { "Z", "X", "C", "V", "B", "N", "M", "<", ">", "?" };
            for (int i = 0; i < pc4Normal.length; i++) {
                addPCCharButton(panelPC, pc4Normal[i], pc4Shift[i], x, y, KW, KH);
                x += KW + GAP;
            }

            return new JScrollPane(panelPC);
        }

        // --- LOGIC: 3270 TAB ---

        private void update3270ShiftState(boolean shifted) {
            this.shift3270Active = shifted;
            refresh3270Visuals();
            panel3270.repaint();
        }

        private void add3270CharButton(JPanel p, String normal, String shifted, int x, int y, int w, int h) {
            JButton btn = new JButton();
            setupButton(btn, p, x, y, w, h, "3270CHAR:" + normal);
            btn.putClientProperty("chars", new String[] { normal, shifted });

            btn.addActionListener(e -> {
                String currentLbl = getVisualLabel(btn, shift3270Active);
                KeyCaptureDialog cap = new KeyCaptureDialog(this, "Press physical key for 3270 '" + currentLbl + "'",
                        false);
                cap.setVisible(true);
                if (cap.cleared) {
                    char targetC = currentLbl.equals("Space") ? ' ' : currentLbl.charAt(0);
                    removeMappingsForTarget(targetC);
                    statusLabel.setText("Restored default for 3270 '" + targetC + "'");
                    refresh3270Visuals();
                } else if (cap.capturedKeyCode != -1) {
                    String[] chars = (String[]) btn.getClientProperty("chars");
                    String targetS = shift3270Active ? chars[1] : chars[0];
                    char targetC = targetS.equals("Space") ? ' ' : targetS.charAt(0);
                    tempKeyMap.put(cap.capturedKeyCode, new TN3270Session.KeyMapping(targetC, "Char: " + targetC));
                    refresh3270Visuals();
                }
            });
            buttons3270.add(btn);
        }

        private void add3270Button(JPanel p, String label, byte aidCode, int x, int y, int w, int h) {
            JButton btn = new JButton();
            setupButton(btn, p, x, y, w, h, "3270FUNC:" + label);

            btn.addActionListener(e -> {
                KeyCaptureDialog cap = new KeyCaptureDialog(this, "Press physical key for " + label, false);
                cap.setVisible(true);

                if (cap.cleared) {
                    removeMappingsForFunction(label, aidCode);
                    refresh3270Visuals();
                } else if (cap.capturedKeyCode != -1) {
                    TN3270Session.KeyMapping newMap;
                    if (label.equals("RESET"))
                        newMap = new TN3270Session.KeyMapping((byte) 0x00, "RESET");
                    else if (label.equals("EraseEOF"))
                        newMap = new TN3270Session.KeyMapping((byte) 0x00, "EraseEOF");
                    else if (label.equals("NEWLINE") || label.equals("R-Shift"))
                        newMap = new TN3270Session.KeyMapping(TN3270Session.AID_ENTER, "NEWLINE");
                    else if (label.equals("Back"))
                        newMap = new TN3270Session.KeyMapping((byte) 0, "BACKSPACE");
                    else if (label.equals("Tab"))
                        newMap = new TN3270Session.KeyMapping((byte) 0, "TAB");
                    else
                        newMap = new TN3270Session.KeyMapping(aidCode, label);

                    tempKeyMap.put(cap.capturedKeyCode, newMap);
                    refresh3270Visuals();
                }
            });
            buttons3270.add(btn);
        }

        // --- LOGIC: PC TAB ---

        private void updatePCShiftState(boolean shifted) {
            this.shiftPCActive = shifted;
            refreshPCVisuals();
            panelPC.repaint();
        }

        private void addPCCharButton(JPanel p, String normal, String shifted, int x, int y, int w, int h) {
            JButton btn = new JButton();
            setupButton(btn, p, x, y, w, h, "PCCHAR:" + normal);
            btn.putClientProperty("chars", new String[] { normal, shifted });

            btn.addActionListener(e -> {
                String src = getVisualLabel(btn, shiftPCActive);
                char inputChar = src.charAt(0);

                if (tempCharMap.containsKey(inputChar)) {
                    int opt = JOptionPane.showConfirmDialog(this,
                            "Clear translation rule for '" + inputChar + "' -> '" + tempCharMap.get(inputChar) + "'?",
                            "Clear Rule", JOptionPane.YES_NO_OPTION);
                    if (opt == JOptionPane.YES_OPTION) {
                        tempCharMap.remove(inputChar);
                        refreshPCVisuals();
                        return;
                    }
                }

                SpecialCharPalette palette = new SpecialCharPalette(this);
                palette.setVisible(true);
                String outStr = palette.getSelected();
                if (outStr != null && !outStr.isEmpty()) {
                    char outputChar = outStr.charAt(0);
                    // FIX: Ignore self-mapping
                    if (inputChar == outputChar) {
                        statusLabel.setText("Ignored trivial translation '" + inputChar + "' -> '" + outputChar + "'");
                    } else {
                        tempCharMap.put(inputChar, outputChar);
                        statusLabel.setText("Rule Added: Input '" + inputChar + "' -> Output '" + outputChar + "'");
                        refreshPCVisuals();
                    }
                }
            });
            buttonsPC.add(btn);
        }

        private void addPCStubButton(JPanel p, String label, int x, int y, int w, int h) {
            JButton btn = new JButton(label);
            btn.setBounds(x, y, w, h);
            btn.setEnabled(false); // Visual only
            p.add(btn);
        }

        // --- SHARED HELPERS ---

        private void setupButton(JButton btn, JPanel p, int x, int y, int w, int h, String id) {
            btn.setBounds(x, y, w, h);
            btn.setFont(new Font("SansSerif", Font.BOLD, 10));
            btn.setMargin(new Insets(0, 0, 0, 0));
            btn.setFocusPainted(false);
            if (!stylesCaptured) {
                defaultBorder = btn.getBorder();
                defaultBg = btn.getBackground();
                stylesCaptured = true;
            }
            btn.putClientProperty("id", id);
            p.add(btn);
        }

        private String getVisualLabel(JButton btn, boolean shifted) {
            String[] chars = (String[]) btn.getClientProperty("chars");
            if (chars != null)
                return shifted ? chars[1] : chars[0];
            return "";
        }

        private void refresh3270Visuals() {
            for (JButton btn : buttons3270) {
                String id = (String) btn.getClientProperty("id");
                boolean mapped = false;
                String labelText = "";
                String mappedTo = "";

                if (id.startsWith("3270CHAR:")) {
                    String[] chars = (String[]) btn.getClientProperty("chars");
                    labelText = shift3270Active ? chars[1] : chars[0];
                    char c = labelText.equals("Space") ? ' ' : labelText.charAt(0);

                    for (Map.Entry<Integer, TN3270Session.KeyMapping> entry : tempKeyMap.entrySet()) {
                        if (entry.getValue().aid == null && entry.getValue().character == c) {
                            mapped = true;
                            mappedTo = KeyEvent.getKeyText(entry.getKey());
                            break;
                        }
                    }
                } else {
                    labelText = id.substring(9);
                    String search = labelText.equals("R-Shift") ? "NEWLINE" : labelText;
                    byte aid = getAidForName(labelText);

                    for (Map.Entry<Integer, TN3270Session.KeyMapping> entry : tempKeyMap.entrySet()) {
                        TN3270Session.KeyMapping km = entry.getValue();
                        if ((km.description != null && km.description.contains(search))
                                || (km.aid != null && km.aid == aid && aid != 0)) {
                            mapped = true;
                            mappedTo = KeyEvent.getKeyText(entry.getKey());
                            break;
                        }
                    }
                }

                applyButtonStyle(btn, labelText, mapped, mappedTo);
            }
        }

        private void refreshPCVisuals() {
            for (JButton btn : buttonsPC) {
                String[] chars = (String[]) btn.getClientProperty("chars");
                String srcChar = shiftPCActive ? chars[1] : chars[0];
                char c = srcChar.charAt(0);

                boolean mapped = tempCharMap.containsKey(c);
                String display = srcChar;
                String tooltip = null;

                if (mapped) {
                    char target = tempCharMap.get(c);
                    display = srcChar + " \u2192 " + target; // Arrow
                    tooltip = "Translates to 3270 symbol: " + target;
                }

                applyButtonStyle(btn, display, mapped, tooltip);
            }
        }

        private void applyButtonStyle(JButton btn, String text, boolean mapped, String tooltip) {
            btn.setText("<html><center>" + text + "</center></html>");

            if (mapped) {
                btn.setBorder(BorderFactory.createLineBorder(new Color(0, 180, 0), 3));
                if (tooltip != null && !tooltip.isEmpty())
                    btn.setToolTipText(tooltip);
            } else {
                btn.setBorder(defaultBorder);
                btn.setBackground(defaultBg);
                btn.setToolTipText("Default");
            }
        }

        private byte getAidForName(String name) {
            if (name.startsWith("PF")) {
                try {
                    return PF_AID_REF[Integer.parseInt(name.substring(2)) - 1];
                } catch (Exception e) {
                }
            }
            if (name.equals("ENTER"))
                return TN3270Session.AID_ENTER;
            if (name.equals("CLEAR"))
                return TN3270Session.AID_CLEAR;
            if (name.equals("PA1"))
                return TN3270Session.AID_PA1;
            if (name.equals("PA2"))
                return TN3270Session.AID_PA2;
            if (name.equals("PA3"))
                return TN3270Session.AID_PA3;
            if (name.equals("ATTN"))
                return TN3270Session.AID_ATTN;
            if (name.equals("SYS REQ"))
                return TN3270Session.AID_SYSREQ;
            return 0;
        }

        private void removeMappingsForTarget(char targetC) {
            tempKeyMap.entrySet()
                    .removeIf(entry -> entry.getValue().aid == null && entry.getValue().character == targetC);
        }

        private void removeMappingsForFunction(String label, byte aid) {
            String search = label.equals("R-Shift") ? "NEWLINE" : label;
            tempKeyMap.entrySet().removeIf(entry -> {
                TN3270Session.KeyMapping km = entry.getValue();
                if (km.description != null && km.description.contains(search))
                    return true;
                if (km.aid != null && km.aid == aid && aid != 0)
                    return true;
                return false;
            });
        }
    }

    /* -------------------- Key Capture Dialog (With Clear) -------------------- */
    static class KeyCaptureDialog extends JDialog {
        public int capturedKeyCode = -1;
        public char capturedChar = 0;
        public boolean cleared = false; // New flag
        private final boolean charMode;

        public KeyCaptureDialog(Dialog owner, String prompt, boolean charMode) {
            super(owner, "Press Key", true);
            this.charMode = charMode;

            setLayout(new BorderLayout());
            setSize(400, 180);
            setLocationRelativeTo(owner);

            JLabel lbl = new JLabel("<html><center>" + prompt + "<br><small>"
                    + (charMode ? "(Type the character)" : "(Press the physical key)") + "</small></center></html>",
                    SwingConstants.CENTER);
            lbl.setFont(new Font("SansSerif", Font.BOLD, 14));
            add(lbl, BorderLayout.CENTER);

            JPanel bottom = new JPanel(new FlowLayout());
            JLabel sub = new JLabel("(Press Esc to cancel)   ", SwingConstants.CENTER);
            sub.setForeground(Color.GRAY);
            bottom.add(sub);

            if (!charMode) {
                JButton clearBtn = new JButton("Clear Assignment");
                clearBtn.setForeground(Color.RED);
                clearBtn.addActionListener(e -> {
                    cleared = true;
                    dispose();
                });
                bottom.add(clearBtn);
            }

            add(bottom, BorderLayout.SOUTH);

            addKeyListener(new KeyAdapter() {
                @Override
                public void keyPressed(KeyEvent e) {
                    int code = e.getKeyCode();
                    if (code == KeyEvent.VK_ESCAPE) {
                        capturedKeyCode = -1;
                        capturedChar = 0;
                        dispose();
                        return;
                    }

                    if (charMode)
                        return;

                    if (code == KeyEvent.VK_SHIFT || code == KeyEvent.VK_CONTROL || code == KeyEvent.VK_ALT
                            || code == KeyEvent.VK_META) {
                        return;
                    }

                    capturedKeyCode = code;
                }

                @Override
                public void keyTyped(KeyEvent e) {
                    if (e.getKeyChar() != KeyEvent.CHAR_UNDEFINED && !Character.isISOControl(e.getKeyChar())
                            && e.getKeyChar() != 27) {

                        capturedChar = e.getKeyChar();
                        if (charMode)
                            dispose();
                    }
                }

                @Override
                public void keyReleased(KeyEvent e) {
                    if (charMode)
                        return;
                    if (capturedKeyCode != -1) {
                        dispose();
                    }
                }
            });

            setFocusable(true);
        }
    }
}