// =======================================================================
    // 6. FILE TRANSFER (IND$FILE) - UI & LOGIC
    // =======================================================================

    // MISSING UI METHOD: File Transfer Setup Dialog
    public void showFileTransferDialog(boolean isDownload) {
        if (!connected) {
            JOptionPane.showMessageDialog(getParentFrame(), "Not connected to host.", "Connection Required",
                    JOptionPane.WARNING_MESSAGE);
            return;
        }

        JDialog dialog = new JDialog(getParentFrame(), isDownload ? "Download from Host" : "Upload to Host", true);
        dialog.setLayout(new BorderLayout());

        JPanel mainPanel = new JPanel(new GridBagLayout());
        mainPanel.setBorder(new EmptyBorder(15, 15, 15, 15));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.anchor = GridBagConstraints.WEST;

        // --- Row 1: Host Type ---
        gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 0;
        mainPanel.add(new JLabel("Host System:"), gbc);

        gbc.gridx = 1; gbc.weightx = 1.0; gbc.gridwidth = 2;
        JComboBox<String> hostTypeBox = new JComboBox<>(new String[] { "TSO (z/OS)", "CMS (z/VM)" });
        hostTypeBox.setSelectedIndex(hostType == HostType.TSO ? 0 : 1);
        mainPanel.add(hostTypeBox, gbc);

        // --- Row 2: Local File ---
        gbc.gridx = 0; gbc.gridy = 1; gbc.weightx = 0; gbc.gridwidth = 1;
        mainPanel.add(new JLabel("Local File:"), gbc);

        gbc.gridx = 1; gbc.weightx = 1.0;
        JTextField localFileField = new JTextField(30);
        mainPanel.add(localFileField, gbc);

        gbc.gridx = 2; gbc.weightx = 0;
        JButton browseBtn = new JButton("Browse...");
        mainPanel.add(browseBtn, gbc);

        // --- Row 3: Host Dataset ---
        gbc.gridx = 0; gbc.gridy = 2;
        JLabel datasetLabel = new JLabel("Host Dataset:");
        mainPanel.add(datasetLabel, gbc);

        gbc.gridx = 1; gbc.weightx = 1.0; gbc.gridwidth = 2;
        JTextField hostDatasetField = new JTextField(30);
        hostDatasetField.setText(hostType == HostType.TSO ? "USER.TEST.DATA" : "TEST DATA A");
        mainPanel.add(hostDatasetField, gbc);

        // --- Row 4: Transfer Mode ---
        gbc.gridx = 0; gbc.gridy = 3; gbc.gridwidth = 1; gbc.weightx = 0;
        mainPanel.add(new JLabel("Transfer Mode:"), gbc);

        gbc.gridx = 1; gbc.gridwidth = 2;
        JComboBox<String> modeBox = new JComboBox<>(new String[] { "ASCII (Text)", "BINARY" });
        mainPanel.add(modeBox, gbc);

        // --- Row 5: Options ---
        gbc.gridx = 0; gbc.gridy = 4; gbc.gridwidth = 3;
        JPanel optionsPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
        JCheckBox crlfCheck = new JCheckBox("CRLF (Text Mode)", true);
        JCheckBox appendCheck = new JCheckBox("Append", false);
        optionsPanel.add(crlfCheck);
        optionsPanel.add(Box.createHorizontalStrut(15));
        optionsPanel.add(appendCheck);
        mainPanel.add(optionsPanel, gbc);

        // --- Advanced Allocation Panel (TSO/CMS Params) ---
        gbc.gridy = 5;
        JPanel allocPanel = new JPanel(new GridBagLayout());
        allocPanel.setBorder(BorderFactory.createTitledBorder("Host Allocation / Format Parameters"));

        GridBagConstraints agbc = new GridBagConstraints();
        agbc.insets = new Insets(2, 5, 2, 5);
        agbc.fill = GridBagConstraints.HORIZONTAL;

        // Line 1: RECFM | LRECL
        agbc.gridx = 0; agbc.gridy = 0; agbc.weightx = 0;
        allocPanel.add(new JLabel("RECFM:"), agbc);

        agbc.gridx = 1; agbc.weightx = 0.5;
        JComboBox<String> recfmBox = new JComboBox<>(new String[] { "V", "F", "U", "" });
        allocPanel.add(recfmBox, agbc);

        agbc.gridx = 2; agbc.weightx = 0;
        allocPanel.add(new JLabel("LRECL:"), agbc);

        agbc.gridx = 3; agbc.weightx = 0.5;
        JTextField lreclField = new JTextField("", 5);
        allocPanel.add(lreclField, agbc);

        // Line 2: BLKSIZE | SPACE
        agbc.gridx = 0; agbc.gridy = 1; agbc.weightx = 0;
        allocPanel.add(new JLabel("BLKSIZE:"), agbc);

        agbc.gridx = 1; agbc.weightx = 0.5;
        JTextField blksizeField = new JTextField("", 6);
        allocPanel.add(blksizeField, agbc);

        agbc.gridx = 2; agbc.weightx = 0;
        JLabel spaceLabel = new JLabel("SPACE:");
        allocPanel.add(spaceLabel, agbc);

        agbc.gridx = 3; agbc.weightx = 0.5;
        JTextField spaceField = new JTextField("", 8);
        spaceField.setToolTipText("Primary,Secondary (TSO Only)");
        allocPanel.add(spaceField, agbc);

        mainPanel.add(allocPanel, gbc);

        dialog.add(mainPanel, BorderLayout.CENTER);

        // --- Bottom Buttons ---
        JPanel btnPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton transferBtn = new JButton(isDownload ? "Download" : "Upload");
        JButton cancelBtn = new JButton("Cancel");

        btnPanel.add(cancelBtn);
        btnPanel.add(transferBtn);
        dialog.add(btnPanel, BorderLayout.SOUTH);

        dialog.getRootPane().setDefaultButton(transferBtn);

        // --- Logic Listeners ---
        hostTypeBox.addActionListener(e -> {
            boolean tso = (hostTypeBox.getSelectedIndex() == 0);
            datasetLabel.setText(tso ? "Host Dataset:" : "Host File:");
            if (tso && hostDatasetField.getText().contains(" ")) hostDatasetField.setText("USER.TEST.DATA");
            else if (!tso && hostDatasetField.getText().contains(".")) hostDatasetField.setText("TEST DATA A");
            spaceLabel.setVisible(tso);
            spaceField.setVisible(tso);
        });

        modeBox.addActionListener(e -> crlfCheck.setEnabled(modeBox.getSelectedIndex() == 0));

        browseBtn.addActionListener(e -> {
            JFileChooser fc = new JFileChooser();
            if (!localFileField.getText().isEmpty()) {
                fc.setSelectedFile(new File(localFileField.getText()));
            }
            int rc = isDownload ? fc.showSaveDialog(dialog) : fc.showOpenDialog(dialog);
            if (rc == JFileChooser.APPROVE_OPTION) {
                localFileField.setText(fc.getSelectedFile().getAbsolutePath());
            }
        });

        transferBtn.addActionListener(e -> {
            String localFile = localFileField.getText().trim();
            String hostDataset = hostDatasetField.getText().trim();

            if (localFile.isEmpty() || hostDataset.isEmpty()) {
                JOptionPane.showMessageDialog(dialog, "Please specify file paths.", "Validation Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            // --- LRECL DEFAULT LOGIC ---
            boolean isAscii = (modeBox.getSelectedIndex() == 0);
            String lrecl = lreclField.getText().trim();
            if (!isDownload && lrecl.isEmpty() && !isAscii) {
                lrecl = "255"; 
            }
            
            // Commit values
            hostType = hostTypeBox.getSelectedIndex() == 0 ? HostType.TSO : HostType.CMS;

            String cmd = buildIndFileCommand(isDownload, hostType == HostType.TSO, hostDataset, isAscii, crlfCheck.isSelected(),
                    appendCheck.isSelected(), (String) recfmBox.getSelectedItem(), lrecl,
                    blksizeField.getText().trim(), spaceField.getText().trim());

            dialog.dispose();

            // Start
            initiateFileTransfer(localFile, cmd, isDownload);
        });

        cancelBtn.addActionListener(e -> dialog.dispose());

        dialog.pack();
        dialog.setLocationRelativeTo(getParentFrame());
        dialog.setVisible(true);
    }

    public void initiateFileTransfer(String localFilePath, String command, boolean isDownload) {
        try {
            currentFile = new File(localFilePath);
            ftDirection = isDownload ? FileTransferDirection.DOWNLOAD : FileTransferDirection.UPLOAD;
            ftIsText = command.toUpperCase().contains("ASCII") || command.toUpperCase().contains("CRLF");
            ftIsMessage = false;
            ftHadSuccessfulTransfer = false;

            System.out.println("Initiating file transfer: " + command);

            showProgressDialog(isDownload ? "Downloading from Host" : "Uploading to Host");
            updateProgressDialog("Sending command to host...", currentFile.getName());

            // Position Cursor and Send Command logic (abbreviated here for context match, but assume full logic)
            // ... (Cursor finding logic) ...
            
            // Send Command
            // ... (Typing logic) ...
            
            // For now, assuming command sent via:
            // sendAID(AID_ENTER);

        } catch (Exception e) {
            e.printStackTrace();
            statusBar.setStatus("File transfer error: " + e.getMessage());
            closeProgressDialog();
        }
    }

    // Build IND$FILE command
    public String buildIndFileCommand(boolean isDownload, boolean isTSO, String hostDataset, boolean isAscii,
            boolean useCrlf, boolean append, String recfm, String lrecl, String blksize, String space) {
        StringBuilder cmd = new StringBuilder();
        cmd.append("IND$FILE ");
        cmd.append(isDownload ? "GET " : "PUT ");
        cmd.append(hostDataset);

        if (!isTSO) { // CMS
            StringBuilder params = new StringBuilder();
            if (isAscii) params.append(" ASCII");
            if (useCrlf && isAscii) params.append(" CRLF");
            if (append) params.append(" APPEND");
            if (!isDownload && !recfm.isEmpty()) {
                params.append(" RECFM ").append(recfm);
                if (!lrecl.isEmpty()) params.append(" LRECL ").append(lrecl);
            }
            if (params.length() > 0) cmd.append(" (").append(params.toString().trim()).append(")");
        } else { // TSO
            if (isAscii) cmd.append(" ASCII");
            if (useCrlf && isAscii) cmd.append(" CRLF");
            if (append) cmd.append(" APPEND");
            if (!isDownload) {
                if (!recfm.isEmpty()) cmd.append(" RECFM(").append(recfm).append(")");
                if (!lrecl.isEmpty()) cmd.append(" LRECL(").append(lrecl).append(")");
                if (!blksize.isEmpty()) cmd.append(" BLKSIZE(").append(blksize).append(")");
                if (!space.isEmpty()) cmd.append(" SPACE(").append(space).append(")");
            } else {
                if (isAscii && !recfm.isEmpty()) cmd.append(" RECFM(").append(recfm).append(")");
            }
        }
        return cmd.toString();
    }

    // --- Helper Methods for Progress Dialog ---

    private void showProgressDialog(String operation) {
        if (progressDialog != null) progressDialog.dispose();

        progressDialog = new JDialog(getParentFrame(), "File Transfer", false);
        progressDialog.setLayout(new BorderLayout());

        JPanel panel = new JPanel(new GridBagLayout());
        panel.setBorder(new EmptyBorder(15, 15, 15, 15));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.gridwidth = 1;

        gbc.gridx = 0; gbc.gridy = 0;
        JLabel title = new JLabel(operation);
        title.setFont(new Font("SansSerif", Font.BOLD, 12));
        panel.add(title, gbc);

        gbc.gridy = 1;
        transferProgressBar = new JProgressBar();
        transferProgressBar.setIndeterminate(true);
        panel.add(transferProgressBar, gbc);

        gbc.gridy = 2;
        progressLabel = new JLabel("Initializing...");
        panel.add(progressLabel, gbc);

        gbc.gridy = 3;
        transferStatusLabel = new JLabel(" ");
        panel.add(transferStatusLabel, gbc);

        gbc.gridy = 4;
        cancelTransferButton = new JButton("Cancel");
        cancelTransferButton.addActionListener(e -> {
            ftState = FileTransferState.IDLE;
            statusBar.setStatus("Transfer cancelled");
            closeProgressDialog();
        });
        panel.add(cancelTransferButton, gbc);

        progressDialog.add(panel, BorderLayout.CENTER);
        progressDialog.pack();
        progressDialog.setLocationRelativeTo(this);
        progressDialog.setVisible(true);
    }

    private void updateProgressDialog(String progress, String status) {
        SwingUtilities.invokeLater(() -> {
            if (progressLabel != null) progressLabel.setText(progress);
            if (transferStatusLabel != null) transferStatusLabel.setText(status);
        });
    }

    private void closeProgressDialog() {
        SwingUtilities.invokeLater(() -> {
            if (progressDialog != null) {
                progressDialog.dispose();
                progressDialog = null;
            }
        });
    }

    // --- Message Dialog Wrappers ---
    private void showMessageDialog(String msg, String title, boolean isError) {
        JOptionPane.showMessageDialog(getParentFrame(), msg, title, isError ? JOptionPane.ERROR_MESSAGE : JOptionPane.INFORMATION_MESSAGE);
    }
    
    private void showMessageDialog(String msg, String title) {
        showMessageDialog(msg, title, false);
    }
