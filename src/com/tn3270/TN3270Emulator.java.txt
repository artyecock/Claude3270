package com.tn3270;

import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.util.*;
import javax.swing.*;
import javax.swing.border.*;
import java.awt.image.BufferedImage;


public class TN3270Emulator extends JFrame {

	// UI Components
	private JTabbedPane tabbedPane;
	private EnhancedRibbonToolbar toolbar;
	private ModernKeyboardPanel keyboardPanel;
	private JMenuBar menuBar;

	// Profile Persistence (Keep this!)
	private static final String PROFILES_FILE = System.getProperty("user.home") + File.separator + ".tn3270profiles";
	private static final Map<String, ConnectionProfile> savedProfiles = new HashMap<>();

	static {
		loadProfiles();
	}

	public TN3270Emulator(String initialModel) {
        super("TN3270 Emulator");
        setLayout(new BorderLayout());
        
        // We handle closing manually to ensure sessions disconnect cleanly
        setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);

        // 1. Setup Tabs (This is the new core component)
        tabbedPane = new JTabbedPane();
        // When switching tabs, give focus to the new session's terminal
        tabbedPane.addChangeListener(e -> {
            TN3270Session s = getCurrentSession();
            if (s != null) s.requestFocusInWindow();
        });
        add(tabbedPane, BorderLayout.CENTER);

        // 2. Handle Initial Session
        // If main() passed a model (e.g. "3279-3"), we open a blank tab for it.
        if (initialModel == null || initialModel.trim().isEmpty()) {
            initialModel = "3279-3";
        }
        // Open the first tab (disconnected)
        openNewSession(null, 0, initialModel, "", false);

        // 3. Setup Menus
        createMenuBar();
        
        // 4. Setup Toolbar (North)
        toolbar = new EnhancedRibbonToolbar(this);
        add(toolbar, BorderLayout.NORTH);

        // 5. Setup Shared Keyboard (South)
        // Note: StatusBar is no longer here; it is inside each Session tab.
        keyboardPanel = new ModernKeyboardPanel(this);
        add(keyboardPanel, BorderLayout.SOUTH);

        // 6. Global Focus Handler
        // This ensures that if you Alt-Tab away and back, or close a dialog,
        // the keystrokes go straight to the terminal, not the toolbar.
        addWindowFocusListener(new WindowAdapter() {
            public void windowGainedFocus(WindowEvent e) {
                TN3270Session s = getCurrentSession();
                if (s != null) s.requestFocusInWindow();
            }
        });

        // 7. Window Close Handler
        addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent e) {
                // Optional: Loop through tabs and disconnect them gracefully
                System.exit(0);
            }
        });

        // 8. Finalize Window
        setSize(1100, 850);
        setLocationRelativeTo(null); // Center on screen
        setVisible(true);
    }

	public TN3270Session getCurrentSession() {
		if (tabbedPane.getTabCount() == 0)
			return null;
		return (TN3270Session) tabbedPane.getSelectedComponent();
	}

	public void openNewSession(String h, int p, String m, String l, boolean t) {
		TN3270Session s = new TN3270Session(m);
		s.setUseTLS(t);
		s.setRequestedLuName(l);
		tabbedPane.addTab(h == null ? "New Session" : h, s);
		tabbedPane.setSelectedComponent(s);
		if (h != null)
			s.connect(h, p);
	}

	public void closeSession(TN3270Session s) {
		s.disconnect();
		tabbedPane.remove(s);
		if (tabbedPane.getTabCount() == 0)
			System.exit(0);
	}
	
	private static void loadProfiles() {
		File file = new File(PROFILES_FILE);

		if (!file.exists()) {
			// Load defaults if no file exists
			savedProfiles.put("Local z/VM", new ConnectionProfile("Local z/VM", "localhost", 23, "3279-3", "", false));
			savedProfiles.put("Local z/OS", new ConnectionProfile("Local z/OS", "localhost", 23, "3279-3", "", false));
			return;
		}

		try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
			String line;
			while ((line = reader.readLine()) != null) {
				String[] parts = line.split(",");

				// Handle different versions of the file format
				if (parts.length >= 5) {
					String name = parts[0];
					String host = parts[1];
					int port = 23;
					try {
						port = Integer.parseInt(parts[2]);
					} catch (Exception e) {
					}
					String model = parts[3];

					// Backward Compatibility Logic
					String luName = "";
					boolean useTLS = false;

					if (parts.length == 5) {
						// OLD Format: Name,Host,Port,Model,TLS
						// parts[4] is TLS boolean
						useTLS = Boolean.parseBoolean(parts[4]);
					} else if (parts.length >= 6) {
						// NEW Format: Name,Host,Port,Model,LU,TLS
						luName = parts[4];
						useTLS = Boolean.parseBoolean(parts[5]);
					}

					savedProfiles.put(name, new ConnectionProfile(name, host, port, model, luName, useTLS));
				}
			}
		} catch (IOException e) {
			System.err.println("Error loading profiles: " + e.getMessage());
		}
	}

	private static void saveProfiles() {
		try (BufferedWriter writer = new BufferedWriter(new FileWriter(PROFILES_FILE))) {
			for (ConnectionProfile profile : savedProfiles.values()) {
				writer.write(profile.name + "," + profile.hostname + "," + profile.port + "," + profile.model + ","
						+ (profile.luName == null ? "" : profile.luName) + "," + profile.useTLS);
				writer.newLine();
			}
		} catch (IOException e) {
			System.err.println("Could not save profiles: " + e.getMessage());
		}
	}


	// Delegates
	// =======================================================================
    // DELEGATE METHODS (Simple Pass-Throughs)
    // =======================================================================
    // These do NOT need pasting. They just route clicks to the active tab.

    public void disconnect() {
        TN3270Session s = getCurrentSession();
        if (s != null) s.disconnect();
    }

    public void reconnect() {
        TN3270Session s = getCurrentSession();
        if (s != null) s.reconnect();
    }

    public void copySelection() {
        TN3270Session s = getCurrentSession();
        if (s != null) s.copySelection();
    }

    public void pasteFromClipboard() {
        TN3270Session s = getCurrentSession();
        if (s != null) s.pasteFromClipboard();
    }

    public void selectAll() {
        TN3270Session s = getCurrentSession();
        if (s != null) s.selectAll();
    }
    
    public String getSelectedText() {
        TN3270Session s = getCurrentSession();
        return (s != null) ? s.getSelectedText() : "";
    }

    // =======================================================================
    // DIALOG METHODS (The UI Logic)
    // =======================================================================
    public void showFileTransferDialog(boolean isDownload) {
        TN3270Session s = getCurrentSession();
        if (s == null || !s.isConnected()) {
            JOptionPane.showMessageDialog(this, "Not connected to host.", "Connection Required", JOptionPane.WARNING_MESSAGE);
            return;
        }

        JDialog dialog = new JDialog(this, isDownload ? "Download from Host" : "Upload to Host", true);
        dialog.setLayout(new BorderLayout());

        JPanel mainPanel = new JPanel(new GridBagLayout());
        mainPanel.setBorder(new EmptyBorder(15, 15, 15, 15));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.anchor = GridBagConstraints.WEST;

        // Host Type
        gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 0;
        mainPanel.add(new JLabel("Host System:"), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0; gbc.gridwidth = 2;
        JComboBox<String> hostTypeBox = new JComboBox<>(new String[] { "TSO (z/OS)", "CMS (z/VM)" });
        mainPanel.add(hostTypeBox, gbc);

        // Local File
        gbc.gridx = 0; gbc.gridy = 1; gbc.weightx = 0; gbc.gridwidth = 1;
        mainPanel.add(new JLabel("Local File:"), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JTextField localFileField = new JTextField(30);
        mainPanel.add(localFileField, gbc);
        gbc.gridx = 2; gbc.weightx = 0;
        JButton browseBtn = new JButton("Browse...");
        mainPanel.add(browseBtn, gbc);

        // Host Dataset
        gbc.gridx = 0; gbc.gridy = 2;
        JLabel datasetLabel = new JLabel("Host Dataset:");
        mainPanel.add(datasetLabel, gbc);
        gbc.gridx = 1; gbc.weightx = 1.0; gbc.gridwidth = 2;
        JTextField hostDatasetField = new JTextField(30);
        // Default based on previous selection logic could go here
        mainPanel.add(hostDatasetField, gbc);

        // Transfer Mode
        gbc.gridx = 0; gbc.gridy = 3; gbc.gridwidth = 1; gbc.weightx = 0;
        mainPanel.add(new JLabel("Transfer Mode:"), gbc);
        gbc.gridx = 1; gbc.gridwidth = 2;
        JComboBox<String> modeBox = new JComboBox<>(new String[] { "ASCII (Text)", "BINARY" });
        mainPanel.add(modeBox, gbc);

        // Options
        gbc.gridx = 0; gbc.gridy = 4; gbc.gridwidth = 3;
        JPanel optionsPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
        JCheckBox crlfCheck = new JCheckBox("CRLF (Text Mode)", true);
        JCheckBox appendCheck = new JCheckBox("Append", false);
        optionsPanel.add(crlfCheck); optionsPanel.add(Box.createHorizontalStrut(15)); optionsPanel.add(appendCheck);
        mainPanel.add(optionsPanel, gbc);

        // Advanced Allocation
        gbc.gridy = 5;
        JPanel allocPanel = new JPanel(new GridBagLayout());
        allocPanel.setBorder(BorderFactory.createTitledBorder("Host Allocation / Format"));
        GridBagConstraints agbc = new GridBagConstraints();
        agbc.insets = new Insets(2, 5, 2, 5); agbc.fill = GridBagConstraints.HORIZONTAL;

        agbc.gridx = 0; agbc.gridy = 0; agbc.weightx = 0;
        allocPanel.add(new JLabel("RECFM:"), agbc);
        agbc.gridx = 1; agbc.weightx = 0.5;
        JComboBox<String> recfmBox = new JComboBox<>(new String[] { "V", "F", "U", "" });
        allocPanel.add(recfmBox, agbc);

        agbc.gridx = 2; agbc.weightx = 0;
        allocPanel.add(new JLabel("LRECL:"), agbc);
        agbc.gridx = 3; agbc.weightx = 0.5;
        JTextField lreclField = new JTextField("", 5);
        allocPanel.add(lreclField, agbc);

        agbc.gridx = 0; agbc.gridy = 1; agbc.weightx = 0;
        allocPanel.add(new JLabel("BLKSIZE:"), agbc);
        agbc.gridx = 1; agbc.weightx = 0.5;
        JTextField blksizeField = new JTextField("", 6);
        allocPanel.add(blksizeField, agbc);

        agbc.gridx = 2; agbc.weightx = 0;
        JLabel spaceLabel = new JLabel("SPACE:");
        allocPanel.add(spaceLabel, agbc);
        agbc.gridx = 3; agbc.weightx = 0.5;
        JTextField spaceField = new JTextField("", 8);
        allocPanel.add(spaceField, agbc);

        mainPanel.add(allocPanel, gbc);
        dialog.add(mainPanel, BorderLayout.CENTER);

        // Buttons
        JPanel btnPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton transferBtn = new JButton(isDownload ? "Download" : "Upload");
        JButton cancelBtn = new JButton("Cancel");
        btnPanel.add(cancelBtn); btnPanel.add(transferBtn);
        dialog.add(btnPanel, BorderLayout.SOUTH);
        dialog.getRootPane().setDefaultButton(transferBtn);

        // --- Logic Listeners ---
        hostTypeBox.addActionListener(e -> {
            boolean isTSO = (hostTypeBox.getSelectedIndex() == 0);
            spaceLabel.setVisible(isTSO); spaceField.setVisible(isTSO);
            datasetLabel.setText(isTSO ? "Host Dataset:" : "Host File:");
        });
        modeBox.addActionListener(e -> crlfCheck.setEnabled(modeBox.getSelectedIndex() == 0));
        
        browseBtn.addActionListener(e -> {
            JFileChooser fc = new JFileChooser();
            if (isDownload) fc.showSaveDialog(dialog); else fc.showOpenDialog(dialog);
            if (fc.getSelectedFile() != null) localFileField.setText(fc.getSelectedFile().getAbsolutePath());
        });

        transferBtn.addActionListener(e -> {
            // 1. Validate
            if (localFileField.getText().trim().isEmpty() || hostDatasetField.getText().trim().isEmpty()) return;
            
            // 2. LRECL Logic (The fix we discussed)
            String lrecl = lreclField.getText().trim();
            String recfm = (String)recfmBox.getSelectedItem();
            boolean ascii = (modeBox.getSelectedIndex() == 0);
            if (!isDownload && "V".equals(recfm) && (lrecl.isEmpty() || Integer.parseInt(lrecl) < 255)) {
                 lrecl = "255"; 
            }

            // 3. Build Command using Session Helper
            String cmd = s.buildIndFileCommand(isDownload, 
                 hostTypeBox.getSelectedIndex() == 0, // isTSO
                 hostDatasetField.getText().trim(), 
                 ascii, crlfCheck.isSelected(), appendCheck.isSelected(), 
                 recfm, lrecl, blksizeField.getText().trim(), spaceField.getText().trim());

            dialog.dispose();
            // 4. Execute on Session
            s.initiateFileTransfer(localFileField.getText().trim(), cmd, isDownload);
        });
        
        cancelBtn.addActionListener(e -> dialog.dispose());
        dialog.pack(); dialog.setLocationRelativeTo(this); dialog.setVisible(true);
    }

    public void showColorSchemeDialog() {
        TN3270Session s = getCurrentSession();
        if (s == null) return;
        
        JDialog dialog = new JDialog(this, "Color Settings", true);
        dialog.setLayout(new BorderLayout());
        JPanel mainPanel = new JPanel(new GridBagLayout());
        mainPanel.setBorder(new EmptyBorder(20, 20, 20, 20));
        
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.HORIZONTAL; gbc.insets = new Insets(5, 5, 5, 5);

        gbc.gridx = 0; gbc.gridy = 0;
        mainPanel.add(new JLabel("Load Preset Scheme:"), gbc);

        gbc.gridy = 1;
        JComboBox<String> schemeBox = new JComboBox<>();
        schemeBox.addItem("Green on Black (Classic)");
        schemeBox.addItem("White on Black");
        schemeBox.addItem("Amber on Black");
        schemeBox.addItem("Green on Dark Green");
        schemeBox.addItem("IBM 3270 Blue");
        schemeBox.addItem("Solarized Dark");

        JButton applyPreset = new JButton("Apply");
        applyPreset.addActionListener(e -> {
            s.applyColorScheme((String) schemeBox.getSelectedItem()); // Call session logic
            dialog.dispose();
        });
        
        JPanel p = new JPanel(new BorderLayout(5,0)); p.add(schemeBox, BorderLayout.CENTER); p.add(applyPreset, BorderLayout.EAST);
        mainPanel.add(p, gbc);
        
        dialog.add(mainPanel, BorderLayout.CENTER);
        dialog.pack(); dialog.setLocationRelativeTo(this); dialog.setVisible(true);
    }

    public void showFontSizeDialog() {
        TN3270Session s = getCurrentSession();
        if (s == null) return;
        
        String current = String.valueOf(s.getFontSize());
        String input = JOptionPane.showInputDialog(this, "Enter Font Size (pt):", current);
        if (input != null) {
            try {
                int size = Integer.parseInt(input);
                s.setFontSize(size);
            } catch (NumberFormatException e) {}
        }
    }

    public void showTerminalSettingsDialog() {
        TN3270Session s = getCurrentSession();
        if (s == null) return;
        
        JDialog dialog = new JDialog(this, "Terminal Settings", true);
        dialog.setLayout(new BorderLayout());
        JPanel p = new JPanel(new GridLayout(0, 2, 10, 10));
        p.setBorder(new EmptyBorder(10,10,10,10));
        
        p.add(new JLabel("Cursor Style:"));
        JComboBox<String> cursorBox = new JComboBox<>(new String[]{"Block", "Underscore", "I-Beam"});
        p.add(cursorBox);
        
        // Toggles
        JCheckBox blink = new JCheckBox("Cursor Blink", true);
        JCheckBox sound = new JCheckBox("Sound", true);
        p.add(blink); p.add(sound);
        
        JButton ok = new JButton("OK");
        ok.addActionListener(e -> {
             // Apply to session
             String style = (String)cursorBox.getSelectedItem();
             if(style.equals("Block")) s.setCursorStyle(TN3270Session.CursorStyle.BLOCK);
             else if(style.equals("Underscore")) s.setCursorStyle(TN3270Session.CursorStyle.UNDERSCORE);
             else s.setCursorStyle(TN3270Session.CursorStyle.I_BEAM);
             // s.setBlink(blink.isSelected());
             // s.setSound(sound.isSelected());
             dialog.dispose();
        });
        
        dialog.add(p, BorderLayout.CENTER);
        dialog.add(ok, BorderLayout.SOUTH);
        dialog.pack(); dialog.setLocationRelativeTo(this); dialog.setVisible(true);
    }

    public void showKeyboardMappingDialog() {
        TN3270Session s = getCurrentSession();
        if (s != null) new KeyboardSettingsDialog(this, s).setVisible(true);
    }

    // =======================================================================
    // STATIC HELPERS (Called by Session or Instance Methods)
    // =======================================================================

    public static void showFileTransferDialogProxy(TN3270Session s, boolean isDownload) {
        if (s == null) return;
        Frame owner = s.getParentFrame();
        
        JDialog dialog = new JDialog(owner, isDownload ? "Download from Host" : "Upload to Host", true);
        dialog.setLayout(new BorderLayout());

        JPanel mainPanel = new JPanel(new GridBagLayout());
        mainPanel.setBorder(new EmptyBorder(15, 15, 15, 15));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5); gbc.fill = GridBagConstraints.HORIZONTAL; gbc.anchor = GridBagConstraints.WEST;

        // Host Type
        gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 0;
        mainPanel.add(new JLabel("Host System:"), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0; gbc.gridwidth = 2;
        JComboBox<String> hostTypeBox = new JComboBox<>(new String[] { "TSO (z/OS)", "CMS (z/VM)" });
        mainPanel.add(hostTypeBox, gbc);

        // Local File
        gbc.gridx = 0; gbc.gridy = 1; gbc.weightx = 0; gbc.gridwidth = 1;
        mainPanel.add(new JLabel("Local File:"), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JTextField localFileField = new JTextField(30);
        mainPanel.add(localFileField, gbc);
        gbc.gridx = 2; gbc.weightx = 0;
        JButton browseBtn = new JButton("Browse...");
        mainPanel.add(browseBtn, gbc);

        // Host Dataset
        gbc.gridx = 0; gbc.gridy = 2;
        JLabel datasetLabel = new JLabel("Host Dataset:");
        mainPanel.add(datasetLabel, gbc);
        gbc.gridx = 1; gbc.weightx = 1.0; gbc.gridwidth = 2;
        JTextField hostDatasetField = new JTextField(30);
        hostDatasetField.setText("USER.TEST.DATA");
        mainPanel.add(hostDatasetField, gbc);

        // Transfer Mode
        gbc.gridx = 0; gbc.gridy = 3; gbc.gridwidth = 1; gbc.weightx = 0;
        mainPanel.add(new JLabel("Transfer Mode:"), gbc);
        gbc.gridx = 1; gbc.gridwidth = 2;
        JComboBox<String> modeBox = new JComboBox<>(new String[] { "ASCII (Text)", "BINARY" });
        mainPanel.add(modeBox, gbc);

        // Options
        gbc.gridx = 0; gbc.gridy = 4; gbc.gridwidth = 3;
        JPanel optionsPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
        JCheckBox crlfCheck = new JCheckBox("CRLF (Text Mode)", true);
        JCheckBox appendCheck = new JCheckBox("Append", false);
        optionsPanel.add(crlfCheck); optionsPanel.add(Box.createHorizontalStrut(15)); optionsPanel.add(appendCheck);
        mainPanel.add(optionsPanel, gbc);

        // Advanced Allocation
        gbc.gridy = 5;
        JPanel allocPanel = new JPanel(new GridBagLayout());
        allocPanel.setBorder(BorderFactory.createTitledBorder("Host Allocation / Format"));
        GridBagConstraints agbc = new GridBagConstraints();
        agbc.insets = new Insets(2, 5, 2, 5); agbc.fill = GridBagConstraints.HORIZONTAL;

        agbc.gridx = 0; agbc.gridy = 0; agbc.weightx = 0;
        allocPanel.add(new JLabel("RECFM:"), agbc);
        agbc.gridx = 1; agbc.weightx = 0.5;
        JComboBox<String> recfmBox = new JComboBox<>(new String[] { "V", "F", "U", "" });
        allocPanel.add(recfmBox, agbc);

        agbc.gridx = 2; agbc.weightx = 0;
        allocPanel.add(new JLabel("LRECL:"), agbc);
        agbc.gridx = 3; agbc.weightx = 0.5;
        JTextField lreclField = new JTextField("", 5);
        allocPanel.add(lreclField, agbc);

        agbc.gridx = 0; agbc.gridy = 1; agbc.weightx = 0;
        allocPanel.add(new JLabel("BLKSIZE:"), agbc);
        agbc.gridx = 1; agbc.weightx = 0.5;
        JTextField blksizeField = new JTextField("", 6);
        allocPanel.add(blksizeField, agbc);

        agbc.gridx = 2; agbc.weightx = 0;
        JLabel spaceLabel = new JLabel("SPACE:");
        allocPanel.add(spaceLabel, agbc);
        agbc.gridx = 3; agbc.weightx = 0.5;
        JTextField spaceField = new JTextField("", 8);
        allocPanel.add(spaceField, agbc);

        mainPanel.add(allocPanel, gbc);
        dialog.add(mainPanel, BorderLayout.CENTER);

        // Buttons
        JPanel btnPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton transferBtn = new JButton(isDownload ? "Download" : "Upload");
        JButton cancelBtn = new JButton("Cancel");
        btnPanel.add(cancelBtn); btnPanel.add(transferBtn);
        dialog.add(btnPanel, BorderLayout.SOUTH);
        dialog.getRootPane().setDefaultButton(transferBtn);

        // --- Logic Listeners ---
        hostTypeBox.addActionListener(e -> {
            boolean isTSO = (hostTypeBox.getSelectedIndex() == 0);
            spaceLabel.setVisible(isTSO); spaceField.setVisible(isTSO);
            datasetLabel.setText(isTSO ? "Host Dataset:" : "Host File:");
        });
        modeBox.addActionListener(e -> crlfCheck.setEnabled(modeBox.getSelectedIndex() == 0));
        
        browseBtn.addActionListener(e -> {
            JFileChooser fc = new JFileChooser();
            if (!localFileField.getText().isEmpty()) fc.setSelectedFile(new File(localFileField.getText()));
            if (isDownload ? fc.showSaveDialog(dialog) == JFileChooser.APPROVE_OPTION : fc.showOpenDialog(dialog) == JFileChooser.APPROVE_OPTION) {
                localFileField.setText(fc.getSelectedFile().getAbsolutePath());
            }
        });

        transferBtn.addActionListener(e -> {
            if (localFileField.getText().trim().isEmpty() || hostDatasetField.getText().trim().isEmpty()) return;
            
            String lrecl = lreclField.getText().trim();
            String recfm = (String)recfmBox.getSelectedItem();
            boolean ascii = (modeBox.getSelectedIndex() == 0);
            
            // LRECL Default Logic
            if (!isDownload && "V".equals(recfm) && (lrecl.isEmpty() || Integer.parseInt(lrecl) < 255)) {
                 lrecl = "255"; 
            }

            // Need to call back to Session to build the command string
            // We assume Session has a public buildIndFileCommand method
            String cmd = s.buildIndFileCommand(isDownload, 
                 hostTypeBox.getSelectedIndex() == 0, // isTSO
                 hostDatasetField.getText().trim(), 
                 ascii, crlfCheck.isSelected(), appendCheck.isSelected(), 
                 recfm, lrecl, blksizeField.getText().trim(), spaceField.getText().trim());

            dialog.dispose();
            s.initiateFileTransfer(localFileField.getText().trim(), cmd, isDownload);
        });
        
        cancelBtn.addActionListener(e -> dialog.dispose());
        dialog.pack(); dialog.setLocationRelativeTo(owner); dialog.setVisible(true);
    }

    public static void showColorSchemeDialogProxy(TN3270Session s) {
        if (s == null) return;
        Frame owner = s.getParentFrame();
        
        JDialog dialog = new JDialog(owner, "Color Settings", true);
        dialog.setLayout(new BorderLayout());
        JPanel mainPanel = new JPanel(new GridBagLayout());
        mainPanel.setBorder(new EmptyBorder(20, 20, 20, 20));
        
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.HORIZONTAL; gbc.insets = new Insets(5, 5, 5, 5);

        gbc.gridx = 0; gbc.gridy = 0;
        mainPanel.add(new JLabel("Load Preset Scheme:"), gbc);

        gbc.gridy = 1;
        JComboBox<String> schemeBox = new JComboBox<>();
        schemeBox.addItem("Green on Black (Classic)");
        schemeBox.addItem("White on Black");
        schemeBox.addItem("Amber on Black");
        schemeBox.addItem("Green on Dark Green");
        schemeBox.addItem("IBM 3270 Blue");
        schemeBox.addItem("Solarized Dark");

        JButton applyPreset = new JButton("Apply");
        applyPreset.addActionListener(e -> {
            s.applyColorScheme((String) schemeBox.getSelectedItem());
            dialog.dispose();
        });
        
        JPanel p = new JPanel(new BorderLayout(5,0)); p.add(schemeBox, BorderLayout.CENTER); p.add(applyPreset, BorderLayout.EAST);
        mainPanel.add(p, gbc);
        
        dialog.add(mainPanel, BorderLayout.CENTER);
        dialog.pack(); dialog.setLocationRelativeTo(owner); dialog.setVisible(true);
    }

    public static void showFontSizeDialogProxy(TN3270Session s) {
        // This one was fine, Session handles the logic
        s.showFontSizeDialog(); 
    }

    public static void showKeyboardMappingDialogProxy(TN3270Session s) {
        if (s != null) {
            new KeyboardSettingsDialog(s.getParentFrame(), s).setVisible(true);
        }
    }

    public static void showTerminalSettingsDialogProxy(TN3270Session s) {
        // We can create the dialog here similar to ColorScheme
        // For brevity, you can paste the full logic, or I can provide if needed.
        // The logic essentially toggles s.setCursorStyle, s.blinkTimer, etc.
        if (s == null) return;
        
        JDialog dialog = new JDialog(s.getParentFrame(), "Terminal Settings", true);
        dialog.setLayout(new BorderLayout());
        JPanel p = new JPanel(new GridLayout(0, 2, 10, 10));
        p.setBorder(new EmptyBorder(10,10,10,10));
        
        p.add(new JLabel("Cursor Style:"));
        JComboBox<String> cursorBox = new JComboBox<>(new String[]{"Block", "Underscore", "I-Beam"});
        // Need getter for cursor style in Session
        // p.add(cursorBox);
        
        p.add(new JLabel("Options:"));
        // Toggles...
        
        JButton ok = new JButton("Close");
        ok.addActionListener(e -> dialog.dispose());
        dialog.add(p, BorderLayout.CENTER);
        dialog.add(ok, BorderLayout.SOUTH);
        dialog.pack(); dialog.setLocationRelativeTo(s.getParentFrame()); dialog.setVisible(true);
    }

    public static void showAIChatDialogProxy(Frame owner, TN3270Session.AIConfig cfg, String text) {
        // Instantiate the AI Window defined in TN3270Session
        TN3270Session.AIManager.getInstance().showChatDialog(owner, text);
    }

    public static void showConnectionDialog() {
        // 1. Find Active Window
        Frame[] frames = Frame.getFrames();
        TN3270Emulator activeWindow = null;
        for (Frame f : frames) {
            if (f instanceof TN3270Emulator && f.isVisible()) {
                activeWindow = (TN3270Emulator) f;
                break;
            }
        }

        JDialog dialog = new JDialog(activeWindow, "Connect to Host", true);
        dialog.setLayout(new BorderLayout(15, 15));
        JPanel mainContainer = new JPanel(new BorderLayout(10, 10));
        mainContainer.setBorder(new EmptyBorder(15, 15, 15, 15));

        // TOP: Profile Selector
        JPanel topPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5); gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 0;
        topPanel.add(new JLabel("Saved Profiles:"), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JComboBox<String> profileChoice = new JComboBox<>();
        profileChoice.addItem("(New Connection)");
        for (String profileName : savedProfiles.keySet()) profileChoice.addItem(profileName);
        topPanel.add(profileChoice, gbc);
        mainContainer.add(topPanel, BorderLayout.NORTH);

        // CENTER: Inputs
        JPanel centerPanel = new JPanel(new GridBagLayout());
        gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 0;
        centerPanel.add(new JLabel("Hostname:", SwingConstants.RIGHT), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JTextField hostnameField = new JTextField("localhost", 20);
        centerPanel.add(hostnameField, gbc);

        gbc.gridx = 0; gbc.gridy = 1; gbc.weightx = 0;
        centerPanel.add(new JLabel("Port:", SwingConstants.RIGHT), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JTextField portField = new JTextField("23", 10);
        centerPanel.add(portField, gbc);

        gbc.gridx = 0; gbc.gridy = 2; gbc.weightx = 0;
        centerPanel.add(new JLabel("LU Name:", SwingConstants.RIGHT), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JTextField luNameField = new JTextField("", 10);
        centerPanel.add(luNameField, gbc);

        gbc.gridx = 0; gbc.gridy = 3; gbc.weightx = 0;
        centerPanel.add(new JLabel("Model:", SwingConstants.RIGHT), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        JComboBox<String> modelChoice = new JComboBox<>();
        modelChoice.addItem("3278-2 (24x80)"); modelChoice.addItem("3279-2 (24x80 Color)");
        modelChoice.addItem("3278-3 (32x80)"); modelChoice.addItem("3279-3 (32x80 Color)");
        modelChoice.addItem("3278-4 (43x80)"); modelChoice.addItem("3278-5 (27x132)");
        modelChoice.setSelectedIndex(3);
        centerPanel.add(modelChoice, gbc);

        gbc.gridx = 1; gbc.gridy = 4; gbc.weightx = 1.0;
        JCheckBox tlsCheckbox = new JCheckBox("Use TLS/SSL encryption");
        centerPanel.add(tlsCheckbox, gbc);
        mainContainer.add(centerPanel, BorderLayout.CENTER);
        dialog.add(mainContainer, BorderLayout.CENTER);

        // BOTTOM: Buttons
        JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT, 10, 10));
        JButton saveButton = new JButton("Save");
        JButton deleteButton = new JButton("Delete"); // Added Delete back
        JButton connectButton = new JButton("Connect");
        JButton cancelButton = new JButton("Cancel");
        
        deleteButton.setEnabled(false);

        bottomPanel.add(saveButton); bottomPanel.add(deleteButton);
        bottomPanel.add(Box.createHorizontalStrut(20));
        bottomPanel.add(connectButton); bottomPanel.add(cancelButton);
        dialog.add(bottomPanel, BorderLayout.SOUTH);
        dialog.getRootPane().setDefaultButton(connectButton);

        // --- LOGIC HANDLERS ---

        // Profile Selection
        profileChoice.addItemListener(e -> {
            if (e.getStateChange() == ItemEvent.SELECTED) {
                String selected = (String) e.getItem();
                if (selected.equals("(New Connection)")) {
                    hostnameField.setText("localhost"); portField.setText("23");
                    luNameField.setText(""); modelChoice.setSelectedIndex(3);
                    tlsCheckbox.setSelected(false); deleteButton.setEnabled(false);
                } else {
                    ConnectionProfile p = savedProfiles.get(selected);
                    if (p != null) {
                        hostnameField.setText(p.hostname); portField.setText(String.valueOf(p.port));
                        luNameField.setText(p.luName==null?"":p.luName); tlsCheckbox.setSelected(p.useTLS);
                        for (int i = 0; i < modelChoice.getItemCount(); i++) {
                            if (modelChoice.getItemAt(i).startsWith(p.model)) { modelChoice.setSelectedIndex(i); break; }
                        }
                        deleteButton.setEnabled(true);
                    }
                }
            }
        });
        
        // Save
        saveButton.addActionListener(e -> {
             String name = JOptionPane.showInputDialog(dialog, "Profile Name:");
             if (name != null && !name.trim().isEmpty()) {
                 int port = 23; try { port = Integer.parseInt(portField.getText().trim()); } catch(Exception x){}
                 String mod = ((String)modelChoice.getSelectedItem()).split(" ")[0];
                 savedProfiles.put(name, new ConnectionProfile(name, hostnameField.getText(), port, mod, luNameField.getText(), tlsCheckbox.isSelected()));
                 saveProfiles();
                 if (((DefaultComboBoxModel)profileChoice.getModel()).getIndexOf(name) == -1) profileChoice.addItem(name);
                 profileChoice.setSelectedItem(name);
             }
        });

        // Delete
        deleteButton.addActionListener(e -> {
            String selected = (String) profileChoice.getSelectedItem();
            if (!selected.equals("(New Connection)")) {
                int confirm = JOptionPane.showConfirmDialog(dialog, "Delete profile '" + selected + "'?", "Confirm", JOptionPane.YES_NO_OPTION);
                if (confirm == JOptionPane.YES_OPTION) {
                    savedProfiles.remove(selected); saveProfiles();
                    profileChoice.removeItem(selected); profileChoice.setSelectedIndex(0);
                }
            }
        });

        // Connect (The Tab-Aware Logic)
        final TN3270Emulator finalWin = activeWindow;
        ActionListener doConnect = e -> {
            String host = hostnameField.getText().trim();
            int port = 23;
            try { port = Integer.parseInt(portField.getText().trim()); } catch (Exception ex) {}
            String modStr = (String) modelChoice.getSelectedItem();
            String model = modStr.split(" ")[0];
            String lu = luNameField.getText().trim();
            boolean tls = tlsCheckbox.isSelected();
            dialog.dispose();

            if (finalWin == null) {
                // No window? Start fresh.
                TN3270Emulator emu = new TN3270Emulator(model);
                emu.openNewSession(host, port, model, lu, tls);
                // Cleanup the blank "New Session" tab if it exists
                if (emu.tabbedPane.getTabCount() > 1 && emu.tabbedPane.getTitleAt(0).equals("New Session")) {
                    emu.tabbedPane.remove(0);
                }
            } else {
                // Window exists? Add Tab.
                finalWin.openNewSession(host, port, model, lu, tls);
            }
        };
        
        connectButton.addActionListener(doConnect);
        cancelButton.addActionListener(e -> dialog.dispose());
        
        dialog.pack(); 
        dialog.setLocationRelativeTo(null); 
        dialog.setVisible(true);
    }

    private void createMenuBar() {
        // 1. Use JMenuBar (Swing)
        JMenuBar menuBar = new JMenuBar();

        // Helper to determine Command (Mac) vs Ctrl (Windows/Linux)
        int shortcutKey = Toolkit.getDefaultToolkit().getMenuShortcutKeyMaskEx();

        // ===== FILE MENU =====
        JMenu fileMenu = new JMenu("File");

        JMenuItem newConnItem = new JMenuItem("New Connection...");
        newConnItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_N, shortcutKey));
        newConnItem.addActionListener(e -> showConnectionDialog());
        fileMenu.add(newConnItem);

        fileMenu.addSeparator();

        JMenuItem uploadItem = new JMenuItem("Upload to Host...");
        uploadItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_U, shortcutKey));
        uploadItem.addActionListener(e -> showFileTransferDialog(false));
        fileMenu.add(uploadItem);

        JMenuItem downloadItem = new JMenuItem("Download from Host...");
        downloadItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_D, shortcutKey));
        downloadItem.addActionListener(e -> showFileTransferDialog(true));
        fileMenu.add(downloadItem);

        fileMenu.addSeparator();

        JMenuItem disconnectItem = new JMenuItem("Disconnect");
        disconnectItem.addActionListener(e -> disconnect());
        fileMenu.add(disconnectItem);

        JMenuItem reconnectItem = new JMenuItem("Reconnect");
        reconnectItem.addActionListener(e -> reconnect());
        fileMenu.add(reconnectItem);

        fileMenu.addSeparator();

        JMenuItem exitItem = new JMenuItem("Exit");
        exitItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_Q, shortcutKey));
        exitItem.addActionListener(e -> {
            // Optional: Close all tabs loop here
            System.exit(0);
        });
        fileMenu.add(exitItem);

        menuBar.add(fileMenu);

        // ===== EDIT MENU =====
        JMenu editMenu = new JMenu("Edit");

        // 1. COPY
        String copyLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Copy    \u2318C"  // Mac: âŒ˜C
                : "Copy    Ctrl+C";  // Win/Linux: Ctrl+C

        JMenuItem copyItem = new JMenuItem(copyLabel);
        // Omitted setAccelerator to let GlobalDispatcher handle it
        copyItem.addActionListener(e -> copySelection());
        editMenu.add(copyItem);

        // 2. PASTE
        String pasteLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Paste    \u2318V"
                : "Paste    Ctrl+V";

        JMenuItem pasteItem = new JMenuItem(pasteLabel);
        // Omitted setAccelerator
        pasteItem.addActionListener(e -> pasteFromClipboard());
        editMenu.add(pasteItem);

        editMenu.addSeparator();

        // 3. SELECT ALL
        String selectAllLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Select All    \u2318A"
                : "Select All    Ctrl+A";

        JMenuItem selectAllItem = new JMenuItem(selectAllLabel);
        // Omitted setAccelerator
        selectAllItem.addActionListener(e -> selectAll());
        editMenu.add(selectAllItem);

        editMenu.addSeparator();

        // 4. ASK AI
        String aiLabel = System.getProperty("os.name").toLowerCase().contains("mac") 
                ? "Ask AI    \u21E7\u2318A" // Shift+Cmd+A
                : "Ask AI    Ctrl+Shift+A";

        JMenuItem askAIItem = new JMenuItem(aiLabel);
        
        // FIX: Reference AIManager via TN3270Session class
        askAIItem.addActionListener(e -> TN3270Session.AIManager.getInstance().showChatDialog(this, getSelectedText()));
        editMenu.add(askAIItem);

        menuBar.add(editMenu);

        // ===== VIEW MENU =====
        JMenu viewMenu = new JMenu("View");

        // Note: It is JCheckBoxMenuItem (Capital B)
        JCheckBoxMenuItem showKeyboardItem = new JCheckBoxMenuItem("Show Keyboard Panel", true);
        showKeyboardItem.addItemListener(e -> {
            keyboardPanel.setVisible(showKeyboardItem.getState());
            // pack(); // Removing pack() prevents resizing window when toggling; revalidate/repaint is safer
            revalidate();
            repaint();
        });
        viewMenu.add(showKeyboardItem);

        viewMenu.addSeparator();

        JMenuItem fontSizeItem = new JMenuItem("Font Size...");
        fontSizeItem.addActionListener(e -> showFontSizeDialog());
        viewMenu.add(fontSizeItem);

        JMenuItem colorSchemeItem = new JMenuItem("Color Scheme...");
        colorSchemeItem.addActionListener(e -> showColorSchemeDialog());
        viewMenu.add(colorSchemeItem);

        menuBar.add(viewMenu);

        // ===== SETTINGS MENU =====
        JMenu settingsMenu = new JMenu("Settings");

        JMenuItem keyboardMapItem = new JMenuItem("Keyboard Mapping...");
        keyboardMapItem.addActionListener(e -> showKeyboardMappingDialog());
        settingsMenu.add(keyboardMapItem);

        JMenuItem terminalSettingsItem = new JMenuItem("Terminal Settings...");
        terminalSettingsItem.addActionListener(e -> showTerminalSettingsDialog());
        settingsMenu.add(terminalSettingsItem);

        menuBar.add(settingsMenu);

        // ===== HELP MENU =====
        JMenu helpMenu = new JMenu("Help");

        JMenuItem aboutItem = new JMenuItem("About");
        aboutItem.addActionListener(e -> showAboutDialog());
        helpMenu.add(aboutItem);

        JMenuItem keyboardHelpItem = new JMenuItem("Keyboard Reference");
        keyboardHelpItem.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_F1, 0));
        keyboardHelpItem.addActionListener(e -> showKeyboardReference());
        helpMenu.add(keyboardHelpItem);

        menuBar.add(helpMenu);

        // FINAL: Use setJMenuBar for JFrame
        setJMenuBar(menuBar);

        this.menuBar = menuBar;
        // this.fileMenu = fileMenu; // Commented out unless you add 'private JMenu fileMenu;' to fields
    }

 // =======================================================================
    // MAIN ENTRY POINT
    // =======================================================================

    public static void main(String[] args) {
        // 1. MacOS Specific Configuration
        String osName = System.getProperty("os.name").toLowerCase();
        if (osName.contains("mac")) {
            System.setProperty("apple.laf.useScreenMenuBar", "true");
            System.setProperty("apple.awt.application.name", "TN3270");
        }

        // 2. Set Look and Feel
        try {
            UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
        } catch (Exception e) {
            System.err.println("Could not set look and feel: " + e.getMessage());
        }

        // 3. If no arguments, show the GUI Dialog immediately
        if (args.length == 0) {
            showConnectionDialog();
            return;
        }

        // 4. Parse Arguments
        String hostname = null;
        int port = 23;
        String rawModel = "3278-2";
        String luName = null;
        boolean useTLS = false;

        try {
            for (int i = 0; i < args.length; i++) {
                String arg = args[i];
                switch (arg) {
                    case "-h": case "--host":
                        if (i + 1 < args.length) hostname = args[++i];
                        else printUsageAndExit("Missing value for host");
                        break;
                    case "-p": case "--port":
                        if (i + 1 < args.length) {
                            try { port = Integer.parseInt(args[++i]); } 
                            catch (NumberFormatException e) { printUsageAndExit("Invalid port: " + args[i]); }
                        } else printUsageAndExit("Missing value for port");
                        break;
                    case "-m": case "--model":
                        if (i + 1 < args.length) rawModel = args[++i];
                        else printUsageAndExit("Missing value for model");
                        break;
                    case "-l": case "--luname":
                        if (i + 1 < args.length) luName = args[++i];
                        else printUsageAndExit("Missing value for LU Name");
                        break;
                    case "--tls":
                        useTLS = true;
                        break;
                    case "--help": case "-?":
                        printUsage();
                        System.exit(0);
                        break;
                    default:
                        if (!arg.startsWith("-") && hostname == null) hostname = arg;
                        else printUsageAndExit("Unknown option: " + arg);
                        break;
                }
            }
        } catch (Exception e) {
            printUsageAndExit("Error parsing arguments: " + e.getMessage());
        }

        if (hostname == null) {
            printUsageAndExit("Hostname is required.");
        }

        String finalModel = normalizeModel(rawModel);

        System.out.println("Connecting to " + hostname + ":" + port + " (" + (useTLS ? "TLS" : "Plain") + ")");
        
        // 5. Launch Emulator with specific session
        // We initialize the frame with the model
        TN3270Emulator emulator = new TN3270Emulator(finalModel);
        
        // The constructor creates a blank "New Session" tab by default.
        // Since we are connecting immediately via CLI, we should close that blank tab
        // and open our specific connection tab.
        TN3270Session blankSession = emulator.getCurrentSession();
        if (blankSession != null) {
            emulator.closeSession(blankSession);
        }
        
        // Open the actual requested connection
        emulator.openNewSession(hostname, port, finalModel, luName, useTLS);
    }

    /**
     * Converts short-hand model codes (2, 3, 4, 5) into full IBM strings.
     */
    private static String normalizeModel(String input) {
        if (input == null) return "3278-2";
        switch (input.trim()) {
            case "2": return "3278-2";
            case "3": return "3278-3";
            case "4": return "3278-4";
            case "5": return "3278-5";
            default: return input.trim();
        }
    }

    private static void printUsage() {
        System.out.println("Usage: java TN3270Emulator [options] <hostname>");
        System.out.println("Options:");
        System.out.println("  -h, --host <name>    Target hostname");
        System.out.println("  -p, --port <num>     Target port (default: 23)");
        System.out.println("  -m, --model <id>     Terminal Model (2, 3, 4, 5 or '3279-3')");
        System.out.println("  -l, --luname <name>  Specific LU Name (TN3270E)");
        System.out.println("  --tls                Enable TLS/SSL");
        System.out.println("  --help               Show this message");
    }

    private static void printUsageAndExit(String error) {
        System.err.println("Error: " + error);
        System.err.println();
        printUsage();
        System.exit(1);
    }

    class EnhancedRibbonToolbar extends JPanel {
        private TN3270Emulator emulator;

        public EnhancedRibbonToolbar(TN3270Emulator emulator) {
            this.emulator = emulator;
            
            setLayout(new BorderLayout());
            setBackground(new Color(245, 245, 245));
            // MatteBorder guarantees the bottom line stretches full width
            setBorder(new MatteBorder(0, 0, 1, 0, new Color(200, 200, 200)));

            // Button Container (Left Aligned)
            JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 2, 2));
            buttonPanel.setOpaque(false);

            // --- Connection Group ---
            // Calls static method on Frame
            buttonPanel.add(createButton("new_conn", "New Connection", e -> TN3270Emulator.showConnectionDialog()));
            // Calls Delegate methods on Frame (which route to Active Session)
            buttonPanel.add(createButton("disconnect", "Disconnect", e -> emulator.disconnect()));
            buttonPanel.add(createButton("reconnect", "Reconnect", e -> emulator.reconnect()));
            buttonPanel.add(createSeparator());

            // --- File Transfer Group ---
            buttonPanel.add(createButton("upload", "Upload to Host", e -> emulator.showFileTransferDialog(false)));
            buttonPanel.add(createButton("download", "Download from Host", e -> emulator.showFileTransferDialog(true)));
            buttonPanel.add(createSeparator());

            // --- Edit Group ---
            buttonPanel.add(createButton("copy", "Copy", e -> emulator.copySelection()));
            buttonPanel.add(createButton("paste", "Paste", e -> emulator.pasteFromClipboard()));
            buttonPanel.add(createButton("select_all", "Select All", e -> emulator.selectAll()));
            buttonPanel.add(createSeparator());

            // --- Settings/View Group ---
            buttonPanel.add(createButton("colors", "Color Scheme", e -> emulator.showColorSchemeDialog()));
            buttonPanel.add(createButton("font", "Font Size", e -> emulator.showFontSizeDialog()));
            buttonPanel.add(createButton("keyboard", "Keyboard Mapping", e -> emulator.showKeyboardMappingDialog()));
            buttonPanel.add(createButton("terminal", "Terminal Settings", e -> emulator.showTerminalSettingsDialog()));
            
            // --- AI Group ---
            buttonPanel.add(createSeparator());
            
            // FIX: Reference AIManager via TN3270Session
            buttonPanel.add(createButton("ai_sparkles", "Ask AI", 
                e -> TN3270Session.AIManager.getInstance().showChatDialog(emulator, emulator.getSelectedText())));
            
            add(buttonPanel, BorderLayout.CENTER);
        }

        private Component createSeparator() {
            JSeparator s = new JSeparator(SwingConstants.VERTICAL);
            s.setPreferredSize(new Dimension(2, 24));
            JPanel p = new JPanel(new FlowLayout(FlowLayout.CENTER, 5, 0));
            p.setOpaque(false);
            p.add(s);
            return p;
        }

        private JButton createButton(String iconName, String toolTip, ActionListener action) {
            BufferedImage img = createEnhancedIcon(iconName);
            ImageIcon icon = new ImageIcon(img);

            JButton btn = new JButton(icon);
            btn.setToolTipText(toolTip);
            btn.addActionListener(action);

            // Fixed size to prevent shrinking/jumping
            Dimension fixedSize = new Dimension(40, 34);
            btn.setPreferredSize(fixedSize);
            btn.setMinimumSize(fixedSize);
            btn.setMaximumSize(fixedSize);

            btn.setFocusable(false);
            btn.setBorderPainted(false);
            btn.setContentAreaFilled(false);
            
            // Invisible border for spacing
            Border emptyBorder = BorderFactory.createEmptyBorder(1, 1, 1, 1);
            Border hoverBorder = BorderFactory.createLineBorder(new Color(180, 200, 220), 1);
            btn.setBorder(emptyBorder);

            btn.addMouseListener(new java.awt.event.MouseAdapter() {
                public void mouseEntered(java.awt.event.MouseEvent evt) {
                    if (btn.isEnabled()) {
                        btn.setContentAreaFilled(true);
                        btn.setBackground(new Color(225, 230, 240)); // Light blue hover
                        btn.setBorderPainted(true);
                        btn.setBorder(hoverBorder);
                    }
                }
                public void mouseExited(java.awt.event.MouseEvent evt) {
                    btn.setContentAreaFilled(false);
                    btn.setBorderPainted(false);
                    btn.setBorder(emptyBorder);
                }
            });
            return btn;
        }

		private BufferedImage createEnhancedIcon(String name) {
			BufferedImage img = new BufferedImage(32, 32, BufferedImage.TYPE_INT_ARGB);
			Graphics2D g = img.createGraphics();
			g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
			g.setStroke(new BasicStroke(2.0f, BasicStroke.CAP_ROUND, BasicStroke.JOIN_ROUND));

			switch (name) {
			case "new_conn":
				g.setColor(new Color(70, 130, 180));
				g.fillRoundRect(4, 8, 24, 16, 4, 4);
				g.setColor(new Color(100, 160, 210));
				g.fillRoundRect(6, 10, 20, 12, 2, 2);
				g.setColor(new Color(50, 180, 50));
				g.fillOval(24, 4, 6, 6);
				break;
			case "disconnect":
				g.setColor(new Color(180, 70, 70));
				g.fillRoundRect(4, 8, 24, 16, 4, 4);
				g.setColor(Color.WHITE);
				g.setStroke(new BasicStroke(2.5f));
				g.drawLine(10, 14, 22, 20);
				g.drawLine(22, 14, 10, 20);
				break;
			case "reconnect":
				g.setColor(new Color(70, 130, 180));
				g.drawArc(8, 8, 16, 16, 45, 270);
				int[] xPoints = { 24, 28, 24 };
				int[] yPoints = { 12, 16, 20 };
				g.fillPolygon(xPoints, yPoints, 3);
				break;
			case "upload":
				g.setColor(new Color(50, 120, 200));
				g.fillRect(10, 18, 12, 10);
				g.setColor(new Color(80, 150, 230));
				g.fillPolygon(new int[] { 16, 8, 16, 16, 24, 16 }, new int[] { 6, 16, 16, 26, 16, 6 }, 6);
				break;
			case "download":
				g.setColor(new Color(50, 120, 200));
				g.fillRect(10, 4, 12, 10);
				g.setColor(new Color(80, 150, 230));
				g.fillPolygon(new int[] { 16, 8, 16, 16, 24, 16 }, new int[] { 26, 16, 16, 6, 16, 26 }, 6);
				break;
			case "copy":
				g.setColor(new Color(100, 100, 100));
				g.fillRoundRect(8, 10, 14, 18, 2, 2);
				g.setColor(new Color(150, 150, 150));
				g.fillRoundRect(12, 6, 14, 18, 2, 2);
				g.setColor(Color.WHITE);
				g.drawLine(14, 10, 22, 10);
				g.drawLine(14, 14, 22, 14);
				g.drawLine(14, 18, 22, 18);
				break;
			case "paste":
				g.setColor(new Color(120, 120, 120));
				g.fillRoundRect(8, 8, 16, 20, 2, 2);
				g.setColor(new Color(180, 180, 180));
				g.fillRoundRect(12, 4, 8, 6, 2, 2);
				g.setColor(Color.WHITE);
				g.fillRect(11, 12, 10, 2);
				g.fillRect(11, 16, 10, 2);
				g.fillRect(11, 20, 10, 2);
				break;
			case "select_all":
				g.setColor(new Color(100, 150, 255));
				g.setStroke(new BasicStroke(2.0f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER, 10.0f,
						new float[] { 4.0f }, 0.0f));
				g.drawRect(6, 6, 20, 20);
				g.setColor(new Color(100, 150, 255, 50));
				g.fillRect(7, 7, 18, 18);
				break;
			case "colors":
				g.setColor(Color.RED);
				g.fillOval(6, 6, 10, 10);
				g.setColor(Color.GREEN);
				g.fillOval(18, 6, 10, 10);
				g.setColor(Color.BLUE);
				g.fillOval(6, 18, 10, 10);
				g.setColor(Color.YELLOW);
				g.fillOval(18, 18, 10, 10);
				break;
			case "font":
				g.setColor(Color.BLACK);
				g.setFont(new Font("SansSerif", Font.BOLD, 20));
				g.drawString("Aa", 6, 24);
				break;
			case "keyboard":
				g.setColor(new Color(80, 80, 80));
				g.fillRoundRect(4, 10, 24, 16, 3, 3);
				g.setColor(new Color(200, 200, 200));
				for (int i = 0; i < 3; i++)
					for (int j = 0; j < 6; j++)
						g.fillRect(6 + j * 4, 12 + i * 4, 2, 3);
				break;
			case "terminal":
				g.setColor(new Color(60, 60, 60));
				g.fillRoundRect(4, 4, 24, 20, 4, 4);
				g.setColor(new Color(50, 200, 50));
				g.fillRect(7, 7, 18, 14);
				g.setColor(new Color(60, 60, 60));
				g.fillRect(10, 24, 12, 3);
				g.fillRect(8, 27, 16, 2);
				break;
			case "ai_sparkles":
				g.setColor(new Color(85, 80, 230));
				g.fillRoundRect(1, 1, 22, 17, 7, 7);
				g.fillPolygon(new int[] { 5, 5, 1 }, new int[] { 17, 23, 17 }, 3);
				g.setColor(Color.WHITE);
				g.fillPolygon(new int[] { 12, 17, 12, 7 }, new int[] { 5, 10, 15, 10 }, 4);
				g.fillPolygon(new int[] { 18, 20, 18, 16 }, new int[] { 4, 6, 8, 6 }, 4);
				break;
			case "ai_robot":
				// Robot Icon
				g.setColor(new Color(80, 80, 80));
				// Antenna stem
				g.drawLine(12, 2, 12, 6);
				// Head outline
				g.drawRoundRect(4, 6, 16, 14, 4, 4);
				// Mouth
				g.drawLine(8, 15, 16, 15);

				// Antenna Bulb (Red)
				g.setColor(Color.RED);
				g.fillOval(10, 0, 4, 4);

				// Eyes (Cyan/Tech Blue)
				g.setColor(new Color(0, 180, 220));
				g.fillRect(7, 10, 3, 3);
				g.fillRect(14, 10, 3, 3);
				break;
			case "ai_neural":
				// Neural Network / Deep Learning Icon

				// 1. Draw the connections (Darker Grey)
				g.setColor(new Color(100, 100, 100));
				// Connect Top to Left
				g.drawLine(12, 6, 6, 17);
				// Connect Top to Right
				g.drawLine(12, 6, 18, 17);
				// Connect Left to Right
				g.drawLine(6, 17, 18, 17);

				// 2. Draw the Nodes (Bright Tech Blue/Cyan)
				g.setColor(new Color(0, 180, 255));

				// Top Node
				g.fillOval(10, 4, 5, 5);
				// Left Node
				g.fillOval(4, 15, 5, 5);
				// Right Node
				g.fillOval(16, 15, 5, 5);

				// 3. Optional: A "pulse" in the center (White)
				g.setColor(Color.WHITE);
				g.fillOval(11, 5, 2, 2); // Highlight on top node
				break;
			case "ai_brain":
				// Digital Brain Icon

				// Brain Outline (Purple/Pink for creativity)
				g.setColor(new Color(160, 60, 220));
				// Draw main brain mass
				g.drawRoundRect(4, 6, 16, 12, 8, 8);

				// Circuitry inside (Bright Green or White)
				g.setColor(new Color(100, 255, 100));
				// Central horizontal trace
				g.drawLine(6, 12, 18, 12);
				// Vertical branching trace
				g.drawLine(12, 8, 12, 16);
				// Data points (nodes on the traces)
				g.fillRect(11, 7, 3, 3);
				g.fillRect(11, 14, 3, 3);
				g.fillRect(5, 11, 3, 3);
				g.fillRect(16, 11, 3, 3);
				break;
			case "ai_chat":
				// 1. The Bubble (Sleek Dark Blue)
				g.setColor(new Color(50, 50, 150));
				g.fillRoundRect(2, 4, 20, 14, 5, 5);
				// The little tail of the bubble
				int[] xPointz = { 6, 6, 2 };
				int[] yPointz = { 18, 22, 18 };
				g.fillPolygon(xPointz, yPointz, 3);

				// 2. The "Voice/Data" Waveform (Orange/Yellow gradient feel)
				g.setColor(Color.ORANGE);
				// Left low bar
				g.fillRect(6, 10, 2, 2);
				// Mid-left medium bar
				g.fillRect(10, 8, 2, 6);
				// Mid-right tall bar
				g.setColor(Color.YELLOW);
				g.fillRect(14, 6, 2, 10);
				// Right low bar
				g.setColor(Color.ORANGE);
				g.fillRect(18, 10, 2, 2);
				break;
			}
			g.dispose();
			return img;
		}
	}

	class ModernKeyboardPanel extends JPanel {
        private TN3270Emulator emulator;

        // Colors
        private final Color COL_FKEY     = new Color(70, 130, 180);  // Steel Blue
        private final Color COL_CLEAR    = new Color(150, 50, 50);   // Red
        private final Color COL_PA       = new Color(180, 130, 70);  // Bronze
        private final Color COL_ENTER    = new Color(50, 150, 50);   // Green
        private final Color COL_RESET    = new Color(100, 100, 100); // Dark Grey
        private final Color COL_INSERT   = new Color(100, 100, 150); // Blue-Grey
        private final Color COL_ERASE    = new Color(120, 100, 100); // Red-Grey
        private final Color COL_NEWLINE  = new Color(100, 120, 100); // Green-Grey
        private final Color COL_TEXT     = Color.WHITE;

        public ModernKeyboardPanel(TN3270Emulator emulator) {
            this.emulator = emulator;
            
            setLayout(new BorderLayout());
            setBackground(new Color(50, 50, 55));
            setBorder(new EmptyBorder(2, 2, 2, 2));
            
            // --- LEFT: KEYS ---
            JPanel keysPanel = new JPanel(new GridBagLayout());
            keysPanel.setOpaque(false);
            GridBagConstraints gbc = new GridBagConstraints();
            gbc.gridx = 0; 
            gbc.weightx = 1.0;
            gbc.fill = GridBagConstraints.HORIZONTAL;
            gbc.insets = new Insets(0, 0, 2, 0);

            // Row 1: F1-F12
            gbc.gridy = 0;
            JPanel row1 = new JPanel(new GridLayout(1, 12, 1, 1));
            row1.setOpaque(false);
            for (int i = 1; i <= 12; i++) {
                // Note: We access constants via TN3270Session class now
                final byte aid = (i <= 9) ? (byte)(TN3270Session.AID_PF1 + i - 1) :
                                 (i == 10)? TN3270Session.AID_PF10 : 
                                 (i == 11)? TN3270Session.AID_PF11 : TN3270Session.AID_PF12;
                row1.add(createButton("F" + i, COL_FKEY, e -> sendAID(aid)));
            }
            keysPanel.add(row1, gbc);

            // Row 2: F13-F24
            gbc.gridy = 1;
            JPanel row2 = new JPanel(new GridLayout(1, 12, 1, 1));
            row2.setOpaque(false);
            for (int i = 13; i <= 24; i++) {
                final int shift = i - 13; 
                final byte aid;
                if (shift <= 8) aid = (byte)(TN3270Session.AID_PF13 + shift); 
                else if (shift == 9) aid = TN3270Session.AID_PF22;
                else if (shift == 10) aid = TN3270Session.AID_PF23;
                else aid = TN3270Session.AID_PF24;
                row2.add(createButton("F" + i, COL_FKEY, e -> sendAID(aid)));
            }
            keysPanel.add(row2, gbc);

            // Row 3: Action Keys (9 Buttons)
            gbc.gridy = 2;
            gbc.insets = new Insets(0, 0, 0, 0);
            JPanel row3 = new JPanel(new GridLayout(1, 9, 1, 1));
            row3.setOpaque(false);

            row3.add(createButton("Clear", COL_CLEAR, e -> {
                TN3270Session s = emulator.getCurrentSession();
                if (s != null && !s.keyboardLocked && s.isConnected()) {
                    // Clear logic is internal to session usually, but sending AID works too
                    s.sendAID(TN3270Session.AID_CLEAR);
                }
            }));
            
            row3.add(createButton("PA1", COL_PA, e -> sendAID(TN3270Session.AID_PA1)));
            row3.add(createButton("PA2", COL_PA, e -> sendAID(TN3270Session.AID_PA2)));
            row3.add(createButton("PA3", COL_PA, e -> sendAID(TN3270Session.AID_PA3))); 
            
            row3.add(createButton("Reset", COL_RESET, e -> {
                TN3270Session s = emulator.getCurrentSession();
                if(s != null) {
                    s.keyboardLocked = false;
                    s.repaint();
                    s.requestFocusInWindow(); 
                }
            }));
            
            row3.add(createButton("Insert", COL_INSERT, e -> {
                 TN3270Session s = emulator.getCurrentSession();
                 if(s != null) s.toggleInsertMode();
            }));
            
            row3.add(createButton("EraseEOF", COL_ERASE, e -> {
                TN3270Session s = emulator.getCurrentSession();
                if(s != null && !s.keyboardLocked && s.isConnected()) {
                    s.eraseToEndOfField();
                    s.requestFocusInWindow();
                }
            }));
            
            row3.add(createButton("Newline", COL_NEWLINE, e -> {
                 TN3270Session s = emulator.getCurrentSession();
                 if(s != null && !s.keyboardLocked && s.isConnected()) {
                     s.tabToNextField();
                     s.requestFocusInWindow();
                 }
            }));
            
            row3.add(createButton("Enter", COL_ENTER, e -> sendAID(TN3270Session.AID_ENTER)));
            
            keysPanel.add(row3, gbc);
            add(keysPanel, BorderLayout.CENTER);

            // --- RIGHT: STATUS PANEL ---
            JPanel statusPanel = createStatusPanel();
            add(statusPanel, BorderLayout.EAST);
        }
        
        private JPanel createStatusPanel() {
            JPanel panel = new JPanel(new GridLayout(3, 1, 2, 2));
            panel.setBackground(new Color(50, 50, 55));
            panel.setBorder(new EmptyBorder(0, 3, 0, 0));
            panel.setPreferredSize(new Dimension(72, 0));

            // 1. Ready/Wait Status
            JPanel kbStatus = new JPanel() {
                @Override protected void paintComponent(Graphics g) {
                    super.paintComponent(g);
                    g.setFont(new Font("SansSerif", Font.BOLD, 9));
                    
                    // FIX: Get state from SESSION, not Emulator
                    TN3270Session s = emulator.getCurrentSession();
                    boolean locked = (s != null && s.keyboardLocked);
                    
                    if (locked) {
                        g.setColor(new Color(255, 200, 0)); 
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.BLACK);
                        g.drawString("X WAIT", 18, 18);
                    } else {
                        g.setColor(new Color(0, 180, 60)); 
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.WHITE);
                        g.drawString("READY", 20, 18);
                    }
                }
            };
            panel.add(kbStatus);

            // 2. Connection Status
            JPanel connStatus = new JPanel() {
                @Override protected void paintComponent(Graphics g) {
                    super.paintComponent(g);
                    g.setFont(new Font("SansSerif", Font.BOLD, 9));
                    
                    // FIX: Get state from SESSION
                    TN3270Session s = emulator.getCurrentSession();
                    boolean connected = (s != null && s.isConnected());

                    if (connected) {
                        g.setColor(new Color(70, 70, 75));
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.CYAN);
                        g.drawString("ONLINE", 18, 18);
                    } else {
                        g.setColor(new Color(40, 40, 45));
                        g.fillRect(0, 0, getWidth(), getHeight());
                        g.setColor(Color.GRAY);
                        g.drawString("OFFLINE", 16, 18);
                    }
                }
            };
            panel.add(connStatus);

            // 3. Insert Mode
            JPanel insStatus = new JPanel() {
                @Override protected void paintComponent(Graphics g) {
                    super.paintComponent(g);
                    g.setFont(new Font("SansSerif", Font.BOLD, 9));
                    g.setColor(new Color(40, 40, 45));
                    g.fillRect(0, 0, getWidth(), getHeight());
                    
                    // FIX: Get state from SESSION
                    TN3270Session s = emulator.getCurrentSession();
                    boolean insert = (s != null && s.insertMode);

                    if (insert) {
                        g.setColor(Color.ORANGE);
                        g.drawString("INS", 26, 18);
                        g.fillRect(12, 8, 8, 2); g.fillRect(15, 5, 2, 8);
                    } else {
                        g.setColor(Color.LIGHT_GRAY);
                        g.drawString("OVR", 26, 18);
                    }
                }
            };
            panel.add(insStatus);
            
            // Timer to redraw status lights (checks active session state)
            //Timer t = new javax.swing.Timer(200, e -> panel.repaint());
            javax.swing.Timer t = new javax.swing.Timer(200, e -> panel.repaint());
            t.start();
            return panel;
        }

        private void sendAID(byte aid) {
            TN3270Session s = emulator.getCurrentSession();
            if (s != null && !s.keyboardLocked && s.isConnected()) {
                s.sendAID(aid);
                s.requestFocusInWindow();
            }
        }

        private JButton createButton(String text, Color bg, ActionListener l) {
            JButton b = new JButton(text) {
                @Override public Dimension getPreferredSize() {
                    FontMetrics fm = getFontMetrics(getFont());
                    return new Dimension(fm.stringWidth(getText()) + 6, 28);
                }

                @Override protected void paintComponent(Graphics g) {
                    Graphics2D g2 = (Graphics2D) g.create();
                    g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    
                    Color fill = bg;
                    if (getModel().isPressed()) fill = bg.darker();
                    else if (getModel().isRollover()) fill = bg.brighter();
                    
                    g2.setColor(fill);
                    g2.fillRoundRect(0, 0, getWidth()-1, getHeight()-1, 8, 8);
                    
                    g2.setColor(bg.darker());
                    g2.drawRoundRect(0, 0, getWidth()-1, getHeight()-1, 8, 8);
                    
                    g2.setColor(COL_TEXT);
                    g2.setFont(getFont());
                    FontMetrics fm = g2.getFontMetrics();
                    int x = (getWidth() - fm.stringWidth(getText())) / 2;
                    int y = (getHeight() + fm.getAscent()) / 2 - 2;
                    g2.drawString(getText(), x, y);
                    
                    g2.dispose();
                }
            };
            
            b.setFont(new Font("SansSerif", Font.BOLD, 10)); 
            b.setMargin(new Insets(0, 0, 0, 0)); 
            b.setFocusable(false); 
            b.setContentAreaFilled(false); 
            b.setBorderPainted(false);
            
            if (l != null) b.addActionListener(l);
            
            return b;
        }
    }
	
	// =======================================================================
    // MISSING HELPERS & INNER CLASSES (Paste at bottom of TN3270Emulator)
    // =======================================================================

    private void showAboutDialog() {
        JOptionPane.showMessageDialog(this, 
            "TN3270 Emulator\nVersion 2.0 (Tabbed)\n\nFeatures:\n- TLS/SSL\n- IND$FILE\n- AI Assistant", 
            "About", JOptionPane.INFORMATION_MESSAGE);
    }

    private void showKeyboardReference() {
        JTextArea ta = new JTextArea(15, 50);
        ta.setText("F1-12: PF1-12\nShift+F1-12: PF13-24\nCtrl+C: Copy\nCtrl+V: Paste\nCtrl+A: Select All");
        ta.setEditable(false);
        JOptionPane.showMessageDialog(this, new JScrollPane(ta), "Reference", JOptionPane.PLAIN_MESSAGE);
    }

    // --- INNER CLASSES ---

    // 1. Connection Profile
    static class ConnectionProfile {
        String name, hostname, model, luName; 
        int port; 
        boolean useTLS;
        
        ConnectionProfile(String n, String h, int p, String m, String lu, boolean t) {
            name=n; hostname=h; port=p; model=m; luName=lu; useTLS=t;
        }
        @Override public String toString() { return name; }
    }

    // 2. AI Preferences Panel (Must be static public so Session can use it)
    public static class AIPreferencesPanel extends JDialog {
        private final TN3270Session.AIConfig config;
        private final JTextArea ta;
        
        public AIPreferencesPanel(Frame owner, TN3270Session.AIConfig cfg) {
            super(owner, "AI Preferences", true);
            this.config = cfg;
            setLayout(new BorderLayout());
            ta = new JTextArea(20, 60);
            ta.setFont(new Font("Monospaced", Font.PLAIN, 12));
            
            try {
                File f = cfg.file();
                if(f.exists()) {
                    BufferedReader r = new BufferedReader(new FileReader(f));
                    String line;
                    while((line=r.readLine())!=null) ta.append(line+"\n");
                    r.close();
                }
            } catch(Exception e) { ta.setText("# Error loading config"); }
            
            add(new JScrollPane(ta), BorderLayout.CENTER);
            
            JPanel b = new JPanel(new FlowLayout(FlowLayout.RIGHT));
            JButton save = new JButton("Save");
            save.addActionListener(e -> {
                try {
                    FileWriter w = new FileWriter(config.file());
                    w.write(ta.getText());
                    w.close();
                    config.load();
                    dispose();
                } catch(Exception x) { x.printStackTrace(); }
            });
            JButton cancel = new JButton("Cancel");
            cancel.addActionListener(e -> dispose());
            
            b.add(save); b.add(cancel);
            add(b, BorderLayout.SOUTH);
            pack(); setLocationRelativeTo(owner);
        }
        public void showDialog() { setVisible(true); }
    }

    // 3. Keyboard Settings Dialog
    static class KeyboardSettingsDialog extends JDialog {
        public KeyboardSettingsDialog(Frame owner, TN3270Session s) {
            super(owner, "Keyboard Mapping", true);
            setLayout(new BorderLayout());
            setSize(500, 400);
            setLocationRelativeTo(owner);
            
            JTextArea info = new JTextArea(
                "To map keys, edit the .tn3270keymap file in your user home directory.\n" +
                "Format:\nKEYCODE_INT = CHAR\n\nExample:\n192 = Â¬  (Maps backtick to logical not)");
            info.setEditable(false);
            info.setMargin(new Insets(10,10,10,10));
            
            add(new JScrollPane(info), BorderLayout.CENTER);
            
            JButton reload = new JButton("Reload Mappings from Disk");
            reload.addActionListener(e -> {
                s.loadKeyMappings();
                JOptionPane.showMessageDialog(this, "Mappings Reloaded");
            });
            
            add(reload, BorderLayout.SOUTH);
        }
    }
}